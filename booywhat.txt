// bot.js - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø­Ø³Ù‘Ù† ÙˆØ§Ù„Ø¬Ø§Ù‡Ø² Ù„Ù„Ù†Ø´Ø±

const { Client, LocalAuth } = require('whatsapp-web.js');
const qrcode = require('qrcode-terminal');
const path = require('path');

// --- Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ---
const config = require('./config');
const state = require('./state');
const db = require('./database');
const { handleStatefulMessage } = require('./state-handler');
const eventHandlers = require('./event-handler');

// --- Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¬Ù…ÙŠØ¹ Ù…Ù„ÙØ§Øª Ø§Ù„Ø£ÙˆØ§Ù…Ø± ---
// ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† ÙƒÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù„ÙØ§Øª Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ù…Ø¬Ù„Ø¯ commands
const adminCommands = require('./commands/admin-commands');
const setupCommands = require('./commands/setup-handler');
const addLectureCommands = require('./commands/add-lecture-commands');
const downloadCommands = require('./commands/download-commands');
const aiCommands = require('./commands/ai-commands');
const pollCommands = require('./commands/poll-commands');
const pdfCommands = require('./commands/pdf-commands');

// --- Ø¯Ù…Ø¬ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙˆØ§Ù…Ø± ÙÙŠ Ø®Ø±ÙŠØ·Ø© ÙˆØ§Ø­Ø¯Ø© Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡Ø§ ---
const commands = {
    ...adminCommands,
    ...setupCommands,
    ...addLectureCommands,
    ...downloadCommands,
    ...aiCommands,
    ...pollCommands,
    ...pdfCommands,
};

console.log('[ğŸš€] Initializing WhatsApp client...');
const client = new Client({
    authStrategy: new LocalAuth({
        clientId: "whatsapp-bot",
        dataPath: path.join(__dirname, '.wwebjs_auth')
    }),
    puppeteer: {
        headless: "new",
        args: [
            '--no-sandbox',
            '--disable-setuid-sandbox',
            '--disable-dev-shm-usage',
            '--disable-accelerated-2d-canvas',
            '--no-first-run',
            '--no-zygote',
            '--disable-gpu',
        ],
    },
    qrTimeout: 120000,
    authTimeout: 120000,
});

// --- Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¹Ù…ÙŠÙ„ ---

client.on('qr', qr => {
    console.log('[ğŸ“¸] Scan the QR code below:');
    qrcode.generate(qr, { small: true });
});

client.on('authenticated', () => {
    console.log('[âœ…] Authenticated successfully!');
});

client.on('ready', async () => {
    state.isBotReady = true;
    console.log('[âœ…] Client is ready!');

    try {
        const chats = await client.getChats();
        chats.forEach(chat => {
            if (chat.isGroup) {
                state.groupsMetadata.set(chat.id._serialized, chat.name);
            }
        });
        console.log(`[â„¹ï¸] Loaded metadata for ${state.groupsMetadata.size} groups.`);

        if (config.OWNER_ID) {
            await client.sendMessage(config.OWNER_ID, `âœ… *Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù† ÙˆØ¬Ø§Ù‡Ø² Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø£ÙˆØ§Ù…Ø±*${config.SIGNATURE}`);
        }
    } catch (error) {
        console.error('[âŒ] Error in ready event:', error);
    }
});

client.on('auth_failure', msg => {
    console.error('[âŒ] Authentication failure:', msg);
    state.isBotReady = false;
    process.exit(1);
});

client.on('disconnected', reason => {
    console.log('[âŒ] Client was logged out:', reason);
    state.isBotReady = false;
});

// --- Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ---
client.on('group_join', (notification) => {
    try {
        eventHandlers.handleGroupJoin(notification, client);
    } catch (error) {
        console.error('[âŒ] Error in group_join event:', error);
    }
});

client.on('group_leave', (notification) => {
    try {
        eventHandlers.handleGroupLeave(notification, client);
    } catch (error) {
        console.error('[âŒ] Error in group_leave event:', error);
    }
});

// ---------------------------------------------------
//          Ø§Ù„Ù…ÙˆØ¬Ù‡ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„
// ---------------------------------------------------
client.on('message_create', async message => {
    if (message.fromMe || !state.isBotReady || !message.body || message.from === 'status@broadcast') {
        return;
    }

    try {
        const wasHandledByState = await handleStatefulMessage(message, client);
        if (wasHandledByState) {
            return;
        }

        const command = message.body.split(' ')[0].toLowerCase();
        const commandHandler = commands[command];

        if (commandHandler) {
            console.log(`[CMD] Executing command "${command}" for ${message.from}`);
            await commandHandler(message, client);
        }
    } catch (error) {
        console.error('[âŒ] An error occurred in message_create handler:', error);
        try {
            await message.reply(`âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: ${error.message}${config.SIGNATURE}`);
        } catch (replyError) {
            console.error('[âŒ] Error sending error message:', replyError);
        }
    }
});

/**
 * @description Ø¯Ø§Ù„Ø© Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª.
 */
async function start() {
    console.log('[ğŸ”„] Initializing database...');
    try {
        console.log('[âœ…] Database connection pool established.');
    } catch (error) {
        console.error('[âŒ] Error initializing database:', error);
        process.exit(1);
    }

    console.log('[ğŸ“‚] Loading initial data from database...');
    try {
        const devData = await db.loadAllData();
        state.admins = new Set((devData.developers || []).map(dev => dev.userid)); //
        
        console.log('--- ADMINS LOADED ---');
        console.log(state.admins);
        console.log('---------------------');

        const coursesData = await db.loadCoursesData();
        state.sections = coursesData.sections;
        state.classes = coursesData.classes;
        state.subjects = coursesData.subjects;
        state.groupsData = coursesData.groups;
        state.professors = coursesData.professors;
        console.log(`[ğŸ“Š] Loaded ${state.sections.size} sections, ${state.classes.size} classes, and other course data.`);

    } catch (error) {
        console.error('[âŒ] CRITICAL: Could not load initial data from database. The bot will not function correctly.', error);
        process.exit(1);
    }

    console.log('[â–¶ï¸] Starting client initialization...');
    await client.initialize();
}

// --- Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù…Ø© ---
process.on('uncaughtException', (error) => {
    console.error('[âŒ] Uncaught Exception:', error);
});

process.on('unhandledRejection', (reason, promise) => {
    console.error('[âŒ] Unhandled Rejection at:', promise, 'reason:', reason);
});

// --- Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª ---
start();


// utils.js - Ù…Ù„Ù Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©

const state = require('./state');
const { OWNER_ID } = require('./config');

/**
 * @description ÙŠØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø´Ø±ÙÙ‹Ø§ ÙÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø¹ÙŠÙ†Ø©.
 * ÙŠØ£Ø®Ø° ÙÙŠ Ø§Ù„Ø§Ø¹ØªØ¨Ø§Ø± Ø£Ù† Ø§Ù„Ù…Ø·ÙˆØ±ÙŠÙ† (admins) Ù‡Ù… Ù…Ø´Ø±ÙÙˆÙ† ÙÙŠ ÙƒÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª.
 * @param {Client} client - Ø¹Ù…ÙŠÙ„ ÙˆØ§ØªØ³Ø§Ø¨.
 * @param {string} userId - Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….
 * @param {string} groupId - Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©.
 * @returns {Promise<boolean>}
 */
async function isAdmin(client, userId, groupId) {
    // Ø§Ù„Ù…Ø·ÙˆØ±ÙˆÙ† (Ø§Ù„Ù…Ø´Ø±ÙÙˆÙ† Ø§Ù„Ø¹Ø§Ù…ÙˆÙ†) Ù„Ù‡Ù… ØµÙ„Ø§Ø­ÙŠØ§Øª ÙÙŠ ÙƒÙ„ Ù…ÙƒØ§Ù†
    if (state.admins.has(userId)) {
        return true;
    }

    try {
        const chat = await client.getChatById(groupId);
        if (!chat.isGroup) return false;

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† ÙˆØªØ­Ø¯ÙŠØ¯ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø´Ø±ÙØ§Ù‹
        const participant = chat.participants.find(p => p.id._serialized === userId);
        return participant ? participant.isAdmin || participant.isSuperAdmin : false;

    } catch (error) {
        console.error(`[âŒ] Error in isAdmin check for group ${groupId}:`, error);
        return false;
    }
}

/**
 * @description ÙŠØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ùˆ Ù…Ø§Ù„Ùƒ Ø§Ù„Ø¨ÙˆØª.
 * @param {string} userId - Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….
 * @returns {boolean}
 */
function isOwner(userId) {
    return userId === OWNER_ID;
}

/**
 * @description ÙŠØ·Ø¨Ø¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ù…Ù†Ø¸Ù…Ø©.
 * @param {Error} error - ÙƒØ§Ø¦Ù† Ø§Ù„Ø®Ø·Ø£.
 * @param {string} context - ÙˆØµÙ Ù„Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø°ÙŠ Ø­Ø¯Ø« ÙÙŠÙ‡ Ø§Ù„Ø®Ø·Ø£.
 */
function logError(error, context = 'General') {
    console.error(`[âŒ] Error in ${context}:`, error.message);
    if (error.stack) {
        console.error(error.stack);
    }
}

module.exports = {
    isAdmin,
    isOwner,
    logError,
};
// state.js

/**
 * @description Ø¥Ø¯Ø§Ø±Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©.
 * ÙŠØ¹Ù…Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù ÙƒØ°Ø§ÙƒØ±Ø© Ù…Ø±ÙƒØ²ÙŠØ© Ù„Ù„Ø¨ÙˆØª (In-Memory State).
 */

module.exports = {
    // --- Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª ---
    isBotReady: false,
    startTime: Date.now(), // Ù„ØªØªØ¨Ø¹ ÙˆÙ‚Øª Ø§Ù„ØªØ´ØºÙŠÙ„

    // --- Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© ---
    // key: userId, value: { step, timestamp, ...data }
    userState: new Map(),

    // --- Ø¨ÙŠØ§Ù†Ø§Øª ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ ---
    sections: new Map(),   // Ø§Ù„Ø´Ø¹Ø¨
    classes: new Map(),    // Ø§Ù„ÙØµÙˆÙ„
    subjects: new Map(),   // Ø§Ù„Ù…ÙˆØ§Ø¯
    groupsData: new Map(), // Ø§Ù„Ø£ÙÙˆØ§Ø¬
    professors: new Map(), // Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©

    // --- Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© ---
    groupsMetadata: new Map(), // Ù„ØªØ®Ø²ÙŠÙ† Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
    blacklist: new Set(),      // Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø© (ÙŠÙ…ÙƒÙ† ØªØ·ÙˆÙŠØ±Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹)
    
    // --- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø·ÙˆØ±ÙŠÙ† (Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† Ø§Ù„Ø¹Ø§Ù…ÙŠÙ†) ---
    // ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    admins: new Set(),
};
// state-handler.js - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…ØµØ­Ø­

const state = require('./state');
const { SIGNATURE, USER_STATE_TIMEOUT } = require('../config');
const db = require('../database');

// --- Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¯ÙˆØ§Ù„ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ù…Ù† Ù…Ù„ÙØ§ØªÙ‡Ø§ Ø§Ù„Ø®Ø§ØµØ© ---
const setupHandlers = require('./commands/setup-handler'); // <-- **Ø§Ù„ØªØµØ­ÙŠØ­ Ù‡Ù†Ø§**
const addLectureHandlers = require('./commands/add-lecture-commands');
const downloadHandlers = require('./commands/download-commands');

/**
 * @description Ø§Ù„Ù…ÙˆØ¬Ù‡ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ø­Ø§Ù„Ø§Øª (State Router).
 */
const allSteps = {
    // --- Ø®Ø·ÙˆØ§Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙƒØ§Ù…Ù„Ø© (!Ø¥Ø¹Ø¯Ø§Ø¯) ---
    'setup_select_action': setupHandlers.handleSetupSelectAction,
    'setup_get_section_name': setupHandlers.handleSetupGetSectionName,
    'setup_get_class_name': setupHandlers.handleSetupGetClassName,
    'setup_get_subjects_for_class': setupHandlers.handleSetupGetSubjects,
    'setup_get_groups_and_profs': setupHandlers.handleSetupGetGroupsAndProfs,
    'setup_ask_for_another_class': setupHandlers.handleAskForAnotherClass,
    'setup_confirm_and_save': setupHandlers.handleSetupConfirmAndSave,

    // --- Ø®Ø·ÙˆØ§Øª Ø¹Ù…Ù„ÙŠØ© Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ø§Ø¶Ø±Ø© (!Ø§Ø¶Ø§ÙØ©_Ù…Ø­Ø§Ø¶Ø±Ø©) ---
    'add_lecture_select_section': addLectureHandlers.handleSelectSection,
    'add_lecture_select_class': addLectureHandlers.handleSelectClass,
    'add_lecture_select_subject': addLectureHandlers.handleSelectSubject,
    'add_lecture_upload_file': addLectureHandlers.handleUploadFile,

    // --- Ø®Ø·ÙˆØ§Øª Ø¹Ù…Ù„ÙŠØ© Ø¹Ø±Ø¶ ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª (!Ø¹Ø±Ø¶_Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª) ---
    'view_lectures_select_section': downloadHandlers.handleViewLecturesSelectSection,
    'view_lectures_select_class': downloadHandlers.handleViewLecturesSelectClass,
    'view_lectures_request_lecture': downloadHandlers.handleRequestLecture,
};

/**
 * @description Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªÙŠ ØªÙƒÙˆÙ† Ø¬Ø²Ø¡Ø§Ù‹ Ù…Ù† Ù…Ø­Ø§Ø¯Ø«Ø© Ù†Ø´Ø·Ø©.
 */
async function handleStatefulMessage(message, client) {
    const authorId = message.author || message.from;

    if (!state.userState.has(authorId)) {
        return false;
    }

    const userState = state.userState.get(authorId);
    const content = message.body.trim();

    if (Date.now() - userState.timestamp > USER_STATE_TIMEOUT) {
        state.userState.delete(authorId);
        await message.reply(`â±ï¸ Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¬Ù„Ø³Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯.${SIGNATURE}`);
        return true;
    }

    if (content.toLowerCase() === 'Ø¥Ù„ØºØ§Ø¡' || content.toLowerCase() === 'cancel') {
        state.userState.delete(authorId);
        await message.reply(`âœ… ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.${SIGNATURE}`);
        return true;
    }

    const handler = allSteps[userState.step];
    if (handler) {
        try {
            userState.timestamp = Date.now();
            await handler(message, client);
        } catch (error) {
            console.error(`[âŒ] Error in state handler for step "${userState.step}":`, error);
            await message.reply(`âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹. ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.${SIGNATURE}`);
            state.userState.delete(authorId);
        }
    } else {
        console.warn(`[âš ï¸] No state handler found for step: ${userState.step}.`);
        await message.reply(`âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…. ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.`);
        state.userState.delete(authorId);
    }

    return true;
}

module.exports = { handleStatefulMessage };
// event-handler.js

const state = require('./state');
const { SIGNATURE } = require('./config');
const { logError } = require('./utils');

/**
 * @description ÙŠØ¹Ø§Ù„Ø¬ Ø­Ø¯Ø« Ø§Ù†Ø¶Ù…Ø§Ù… Ø¹Ø¶Ùˆ Ø¬Ø¯ÙŠØ¯ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©.
 * @param {GroupNotification} notification - Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù….
 * @param {Client} client - Ø¹Ù…ÙŠÙ„ ÙˆØ§ØªØ³Ø§Ø¨.
 */
async function handleGroupJoin(notification, client) {
    try {
        const groupId = notification.chatId;
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ø¹Ø¶Ùˆ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        const contact = await client.getContactById(notification.recipientIds[0]);
        const userName = contact.pushname || contact.name || "Ø§Ù„Ø¹Ø¶Ùˆ Ø§Ù„Ø¬Ø¯ÙŠØ¯";
        const groupName = state.groupsMetadata.get(groupId) || "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©";

        // Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ Ø°ÙƒÙŠØ©
        const welcomeMessage = `
ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ ${userName} ÙÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø© *${groupName}*!

Ù†ØªÙ…Ù†Ù‰ Ù„Ùƒ ÙˆÙ‚ØªØ§Ù‹ Ù…Ù…ØªØ¹Ø§Ù‹ ÙˆÙ…ÙÙŠØ¯Ø§Ù‹ Ù…Ø¹Ù†Ø§. âœ¨

${SIGNATURE}
        `;
        
        await client.sendMessage(groupId, welcomeMessage);
        console.log(`[+] Welcomed new member ${userName} to group ${groupName}.`);

    } catch (error) {
        logError(error, 'handleGroupJoin');
    }
}

/**
 * @description ÙŠØ¹Ø§Ù„Ø¬ Ø­Ø¯Ø« Ù…ØºØ§Ø¯Ø±Ø© Ø¹Ø¶Ùˆ Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©.
 * @param {GroupNotification} notification - Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©.
 * @param {Client} client - Ø¹Ù…ÙŠÙ„ ÙˆØ§ØªØ³Ø§Ø¨.
 */
async function handleGroupLeave(notification, client) {
    try {
        const groupId = notification.chatId;
        const contact = await client.getContactById(notification.recipientIds[0]);
        const userName = contact.pushname || contact.name;

        console.log(`[-] Member ${userName} left group ${state.groupsMetadata.get(groupId)}.`);
        
        // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ù‡Ù†Ø§ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ÙˆØ¯Ø§Ø¹ Ù„Ù„Ù…Ø´Ø±ÙÙŠÙ† Ø£Ùˆ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¯Ø«
        // await client.sendMessage(config.OWNER_ID, ` FYI: ${userName} left ${state.groupsMetadata.get(groupId)}.`);

    } catch (error) {
        logError(error, 'handleGroupLeave');
    }
}

module.exports = {
    handleGroupJoin,
    handleGroupLeave,
};
// database.js - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ÙˆØ§Ù„Ù…ØµØ­Ø­ Ù„Ù€ Supabase

const { Pool } = require('pg');
const { DATABASE_URL } = require('./config');

if (!DATABASE_URL) {
    throw new Error('[âŒ] FATAL: DATABASE_URL is not defined in environment variables. Please check your .env file or Render configuration.');
}

const pool = new Pool({
    connectionString: DATABASE_URL,
    ssl: { rejectUnauthorized: false }
});

console.log('[âœ…] Database connection pool for PostgreSQL (Supabase) created.');

/**
 * @description ÙŠØ­Ù…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·ÙˆØ±ÙŠÙ† ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„.
 */
async function loadAllData() {
    const client = await pool.connect();
    console.log('[DB] Attempting to load developers data...');
    try {
        const devResult = await client.query("SELECT userId FROM developers");
        console.log(`[DB] Success! Found ${devResult.rows.length} developer(s) in the database.`);
        // Supabase ØªØ±Ø¬Ø¹ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø­Ø±ÙˆÙ ØµØºÙŠØ±Ø© (userid)
        return { developers: devResult.rows.map(row => ({ userId: row.userid })) };
    } catch (error) {
        console.error('[âŒ] FATAL: Failed to execute query to load developers.', error);
        throw error;
    } finally {
        client.release();
    }
}

/**
 * @description ÙŠØ­Ù…Ù„ ÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‚Ø±Ø±Ø§Øª (Ø§Ù„Ø´Ø¹Ø¨ØŒ Ø§Ù„ÙØµÙˆÙ„ØŒ Ø¥Ù„Ø®) Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.
 */
async function loadCoursesData() {
    const client = await pool.connect();
    console.log('[DB] Attempting to load course data...');
    try {
        const sectionsResult = await client.query("SELECT * FROM sections");
        const classesResult = await client.query("SELECT * FROM classes");
        const subjectsResult = await client.query("SELECT * FROM subjects");
        const groupsResult = await client.query("SELECT * FROM course_groups");
        const professorsResult = await client.query("SELECT * FROM professors");

        const sections = new Map(sectionsResult.rows.map(row => [row.id, row]));
        const classes = new Map(classesResult.rows.map(row => [row.id, row]));
        const subjects = new Map(subjectsResult.rows.map(row => [row.id, row]));
        const groups = new Map(groupsResult.rows.map(row => [row.id, row]));
        const professors = new Map(professorsResult.rows.map(row => [row.id, row]));
        
        console.log(`[DB] Success! Loaded ${sections.size} sections, ${classes.size} classes, etc.`);
        return { sections, classes, subjects, groupsData: groups, professors };
    } catch (error) {
        console.error('[âŒ] Error loading courses data:', error);
        return { sections: new Map(), classes: new Map(), subjects: new Map(), groupsData: new Map(), professors: new Map() };
    } finally {
        client.release();
    }
}

/**
 * @description ÙŠØ¶ÙŠÙ Ù…Ø·ÙˆØ±Ù‹Ø§ Ø¬Ø¯ÙŠØ¯Ù‹Ø§.
 */
function addDeveloper(userId) {
    const query = "INSERT INTO developers (userId) VALUES ($1) ON CONFLICT (userId) DO NOTHING";
    return pool.query(query, [userId]).then(res => res.rowCount);
}

/**
 * @description ÙŠØ­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø´Ø¹Ø¨Ø© ÙƒØ§Ù…Ù„Ø© ÙÙŠ Ø¹Ù…Ù„ÙŠØ© ÙˆØ§Ø­Ø¯Ø© (Transaction).
 * @param {object} setupData - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙŠ ØªÙ… Ø¬Ù…Ø¹Ù‡Ø§ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….
 */
async function saveSectionSetup(setupData) {
    const client = await pool.connect();
    try {
        await client.query('BEGIN'); // Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Transaction

        // 1. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø¹Ø¨Ø©
        const sectionRes = await client.query('INSERT INTO sections (name) VALUES ($1) RETURNING id', [setupData.sectionName]);
        const sectionId = sectionRes.rows[0].id;

        // 2. ØªÙƒØ±Ø§Ø± Ù„ÙƒÙ„ ÙØµÙ„
        for (const classData of setupData.classes) {
            if (!classData) continue;

            const classRes = await client.query('INSERT INTO classes (name, section_id) VALUES ($1, $2) RETURNING id', [classData.className, sectionId]);
            const classId = classRes.rows[0].id;

            // 3. ØªÙƒØ±Ø§Ø± Ù„ÙƒÙ„ Ù…Ø§Ø¯Ø©
            for (const subjectName of classData.subjects) {
                await client.query('INSERT INTO subjects (name, class_id) VALUES ($1, $2)', [subjectName, classId]);
            }

            // 4. ØªÙƒØ±Ø§Ø± Ù„ÙƒÙ„ ÙÙˆØ¬ ÙˆØ£Ø³ØªØ§Ø°
            for (const groupData of classData.groups) {
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø³ØªØ§Ø° (Ù…Ø¹ ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ØªÙƒØ±Ø§Ø±)
                const profRes = await client.query('INSERT INTO professors (name) VALUES ($1) ON CONFLICT (name) DO UPDATE SET name = EXCLUDED.name RETURNING id', [groupData.professorName]);
                const professorId = profRes.rows[0].id;

                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙÙˆØ¬
                const groupRes = await client.query('INSERT INTO course_groups (name, class_id) VALUES ($1, $2) RETURNING id', [groupData.groupName, classId]);
            }
        }

        await client.query('COMMIT'); // ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¥Ø°Ø§ Ù†Ø¬Ø­Øª
        console.log(`[DB] Successfully saved new section: ${setupData.sectionName}`);
    } catch (error) {
        await client.query('ROLLBACK'); // Ø§Ù„ØªØ±Ø§Ø¬Ø¹ ÙÙŠ Ø­Ø§Ù„Ø© Ø­Ø¯ÙˆØ« Ø£ÙŠ Ø®Ø·Ø£
        console.error('[âŒ] Error in saveSectionSetup transaction:', error);
        throw new Error('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.');
    } finally {
        client.release(); // ØªØ­Ø±ÙŠØ± Ø§Ù„Ø§ØªØµØ§Ù„
    }
}

module.exports = {
    pool,
    query: (text, params) => pool.query(text, params),
    loadAllData,
    loadCoursesData,
    addDeveloper,
    saveSectionSetup, // ØªØ£ÙƒØ¯ Ù…Ù† ØªØµØ¯ÙŠØ± Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø©
};
// config.js - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø§Ù„Ø¬Ø§Ù‡Ø² Ù„Ù„Ù†Ø´Ø±

// Ø§Ø³ØªÙŠØ±Ø§Ø¯ dotenv Ù„ØªØ­Ù…ÙŠÙ„ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© Ù…Ù† Ù…Ù„Ù .env Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ù…Ø­Ù„ÙŠ
require('dotenv').config();

module.exports = {
    // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ---
    SIGNATURE: process.env.SIGNATURE || '\n\nğŸ¤– Ø¨ÙˆØ§Ø³Ø·Ø© Ø¨ÙˆØª Ø§Ù„Ù…Ø·ÙˆØ±',

    // --- Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø§Ù„Ùƒ (ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØªÙ‡ ÙÙŠ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© Ø¹Ù„Ù‰ Render) ---
    // Ù…Ø«Ø§Ù„: 2126xxxxxxxx@c.us
    OWNER_ID: process.env.OWNER_ID,

    // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Supabase) ---
    // Ù‡Ø°Ø§ Ù‡Ùˆ Ø±Ø§Ø¨Ø· Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø°ÙŠ Ù†Ø³Ø®ØªÙ‡ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Supabase
    DATABASE_URL: process.env.DATABASE_URL,

    // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ù„ÙØ§Øª (GitHub) ---
    // Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ø°ÙŠ Ù‚Ù…Øª Ø¨Ø¥Ù†Ø´Ø§Ø¦Ù‡ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø­Ø³Ø§Ø¨Ùƒ ÙÙŠ GitHub
    GITHUB_TOKEN: process.env.GITHUB_TOKEN,
    // Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù…Ùƒ Ø¹Ù„Ù‰ GitHub
    GITHUB_OWNER: process.env.GITHUB_OWNER,
    // Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ (Repository) Ø§Ù„Ø°ÙŠ Ø³ØªØ®Ø²Ù† ÙÙŠÙ‡ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª
    GITHUB_REPO: process.env.GITHUB_REPO,

    // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù‡Ù„Ø© Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ---
    // Ø§Ù„Ù…Ù‡Ù„Ø© Ø¨Ø§Ù„Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ© (Ù‡Ù†Ø§ 10 Ø¯Ù‚Ø§Ø¦Ù‚)
    USER_STATE_TIMEOUT: 10 * 60 * 1000,

    // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ---
    AI_API_KEY: process.env.AI_API_KEY,

    // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØµØ­ÙŠØ­ ÙˆØ§Ù„Ø£Ø®Ø·Ø§Ø¡ ---
    // Ø§Ø¶Ø¨Ø·Ù‡Ø§ Ø¹Ù„Ù‰ 'true' ÙÙŠ Render Ù„Ø¥Ø¸Ù‡Ø§Ø± ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ·ÙˆÙŠØ±
    DEBUG_MODE: process.env.DEBUG_MODE === 'true' || false,
};
// commands/add-lecture-commands.js - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„ ÙˆØ§Ù„Ù…ØµØ­Ø­

const { isAdmin } = require('../utils');
const { SIGNATURE, GITHUB_TOKEN, GITHUB_OWNER, GITHUB_REPO } = require('../config');
const state = require('../state');
const db = require('../database');
const { Octokit } = require("@octokit/rest");

// --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ GitHub ---
if (!GITHUB_TOKEN || !GITHUB_OWNER || !GITHUB_REPO) {
    console.warn('[âš ï¸] GitHub configuration is missing. File uploads will fail.');
}
const octokit = new Octokit({ auth: GITHUB_TOKEN });

/**
 * @description ÙŠØ¨Ø¯Ø£ Ø¹Ù…Ù„ÙŠØ© Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ø§Ø¶Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©.
 */
async function handleAddLectureCommand(message, client) {
    const chat = await message.getChat();
    const authorId = message.author || message.from;

    if (!(await isAdmin(client, authorId, chat.id._serialized))) {
        return message.reply(`âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± Ù…ØªØ§Ø­ Ù„Ù„Ù…Ø´Ø±ÙÙŠÙ† ÙÙ‚Ø·!${SIGNATURE}`);
    }

    if (state.sections.size === 0) {
        return message.reply(`âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø¹Ø¨ Ù…Ø¶Ø§ÙØ© Ø¨Ø¹Ø¯. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… !Ø¥Ø¹Ø¯Ø§Ø¯ Ø£ÙˆÙ„Ø§Ù‹.${SIGNATURE}`);
    }

    let list = 'ğŸ“š *Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ø§Ø¶Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©*\n\nÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ø¹Ø¨Ø©:\n\n';
    Array.from(state.sections.values()).forEach((section, i) => {
        list += `${i + 1}. ${section.name}\n`;
    });
    list += `\nğŸ’¡ Ø£Ø±Ø³Ù„ Ø±Ù‚Ù… Ø§Ù„Ø®ÙŠØ§Ø± Ø£Ùˆ *Ø¥Ù„ØºØ§Ø¡*.`;

    await message.reply(list);
    state.userState.set(authorId, {
        step: 'add_lecture_select_section',
        timestamp: Date.now(),
        lectureData: {} // ÙƒØ§Ø¦Ù† Ù„ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©
    });
}

// --- Ø¯ÙˆØ§Ù„ Ø§Ù„Ø®Ø·ÙˆØ§Øª (Ø³ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§ Ù…Ù† state-handler.js) ---

async function handleSelectSection(message) {
    const authorId = message.author || message.from;
    const userState = state.userState.get(authorId);
    const choice = parseInt(message.body.trim());
    const sectionsArray = Array.from(state.sections.values());

    if (isNaN(choice) || choice < 1 || choice > sectionsArray.length) {
        return message.reply('âš ï¸ Ø±Ù‚Ù… ØºÙŠØ± ØµØ§Ù„Ø­. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø±Ù‚Ù… Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.');
    }

    const selectedSection = sectionsArray[choice - 1];
    userState.lectureData.sectionId = selectedSection.id;
    userState.lectureData.sectionName = selectedSection.name;

    const classesInSection = Array.from(state.classes.values()).filter(c => c.section_id === selectedSection.id);
    if (classesInSection.length === 0) {
        state.userState.delete(authorId);
        return message.reply(`âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØµÙˆÙ„ Ù…Ø¶Ø§ÙØ© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø¹Ø¨Ø©.${SIGNATURE}`);
    }

    let list = 'ğŸ« *Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„:*\n\n';
    classesInSection.forEach((cls, i) => list += `${i + 1}. ${cls.name}\n`);
    await message.reply(list);

    userState.step = 'add_lecture_select_class';
    userState.tempData = classesInSection; // ØªØ®Ø²ÙŠÙ† Ù…Ø¤Ù‚Øª Ù„Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ©
}

async function handleSelectClass(message) {
    const authorId = message.author || message.from;
    const userState = state.userState.get(authorId);
    const choice = parseInt(message.body.trim());
    const classesArray = userState.tempData;

    if (isNaN(choice) || choice < 1 || choice > classesArray.length) {
        return message.reply('âš ï¸ Ø±Ù‚Ù… ØºÙŠØ± ØµØ§Ù„Ø­. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø±Ù‚Ù… Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.');
    }

    const selectedClass = classesArray[choice - 1];
    userState.lectureData.classId = selectedClass.id;
    userState.lectureData.className = selectedClass.name;

    const subjectsInClass = Array.from(state.subjects.values()).filter(s => s.class_id === selectedClass.id);
     if (subjectsInClass.length === 0) {
        state.userState.delete(authorId);
        return message.reply(`âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯ Ù…Ø¶Ø§ÙØ© Ù„Ù‡Ø°Ø§ Ø§Ù„ÙØµÙ„.${SIGNATURE}`);
    }
    
    let list = 'ğŸ“– *Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©:*\n\n';
    subjectsInClass.forEach((sub, i) => list += `${i + 1}. ${sub.name}\n`);
    await message.reply(list);

    userState.step = 'add_lecture_select_subject';
    userState.tempData = subjectsInClass;
}

async function handleSelectSubject(message) {
    const authorId = message.author || message.from;
    const userState = state.userState.get(authorId);
    const choice = parseInt(message.body.trim());
    const subjectsArray = userState.tempData;

    if (isNaN(choice) || choice < 1 || choice > subjectsArray.length) {
        return message.reply('âš ï¸ Ø±Ù‚Ù… ØºÙŠØ± ØµØ§Ù„Ø­. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø±Ù‚Ù… Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.');
    }

    const selectedSubject = subjectsArray[choice - 1];
    userState.lectureData.subjectId = selectedSubject.id;
    userState.lectureData.subjectName = selectedSubject.name;
    
    // Ø§Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¢Ù†
    await message.reply(`âœ… ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø§Ø¯Ø©: *${selectedSubject.name}*.\n\nØ§Ù„Ø¢Ù†ØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ù…Ù„Ù Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© (PDF).`);
    userState.step = 'add_lecture_upload_file';
}

async function handleUploadFile(message) {
    const authorId = message.author || message.from;
    const userState = state.userState.get(authorId);

    if (!message.hasMedia || message.type !== 'document') {
        return message.reply(`âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ù…Ù„Ù Ø¨ØµÙŠØºØ© PDF.`);
    }
    
    const media = await message.downloadMedia();
    if (!media || !media.mimetype.includes('pdf')) {
        return message.reply(`âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø£Ùˆ Ø£Ù† Ø§Ù„Ù…Ù„Ù Ù„ÙŠØ³ Ø¨ØµÙŠØºØ© PDF. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.`);
    }

    await message.react('ğŸ”„');

    const fileName = `lectures/${userState.lectureData.sectionName}/${userState.lectureData.className}/${userState.lectureData.subjectName}-${Date.now()}.pdf`;

    try {
        await octokit.repos.createOrUpdateFileContents({
            owner: GITHUB_OWNER,
            repo: GITHUB_REPO,
            path: fileName,
            message: `BOT: Add lecture - ${fileName}`,
            content: media.data,
        });

        // Ø§Ø³ØªØ®Ø¯Ø§Ù… @main Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† @latest Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£Ø­Ø¯Ø« Ù†Ø³Ø®Ø© ÙÙˆØ±Ø§Ù‹
        const downloadUrl = `https://cdn.jsdelivr.net/gh/${GITHUB_OWNER}/${GITHUB_REPO}@main/${fileName}`;
        
        // Ø³Ù†Ø­ØªØ§Ø¬ Ù„Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ÙÙŠ database.js
        // await db.saveLectureInDB({
        //    fileName: fileName,
        //    fileUrl: downloadUrl,
        //    subjectId: userState.lectureData.subjectId,
        //    uploaderId: authorId,
        // });

        await message.reply(`âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© ÙˆØ±ÙØ¹Ù‡Ø§ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ø¨Ù†Ø¬Ø§Ø­!${SIGNATURE}`);

    } catch (error) {
        console.error('[âŒ] Error uploading to GitHub:', error);
        await message.reply(`âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙØ§Ø¯Ø­ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±ÙØ¹. ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª GitHub.`);
    } finally {
        state.userState.delete(authorId);
    }
}

module.exports = {
    '!Ø§Ø¶Ø§ÙØ©_Ù…Ø­Ø§Ø¶Ø±Ø©': handleAddLectureCommand,
    '!add_lecture': handleAddLectureCommand,

    // ØªØµØ¯ÙŠØ± ÙƒÙ„ Ø¯ÙˆØ§Ù„ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ù„ÙŠØ³ØªØ®Ø¯Ù…Ù‡Ø§ state-handler
    handleSelectSection,
    handleSelectClass,
    handleSelectSubject,
    handleUploadFile,
};
// commands/admin-commands.js

const { isOwner, logError } = require('../utils');
const { SIGNATURE } = require('../config');
const state = require('../state');
const db = require('../database');

/**
 * @description ÙŠØ¶ÙŠÙ Ù…Ø³ØªØ®Ø¯Ù…Ù‹Ø§ ÙƒÙ…Ø·ÙˆØ± (Ù…Ø´Ø±Ù Ø¹Ø§Ù…).
 * @param {Message} message - ÙƒØ§Ø¦Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø©.
 */
async function handleAddDeveloper(message) {
    if (!isOwner(message.author || message.from)) {
        return message.reply(`âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± Ù…ØªØ§Ø­ Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·!${SIGNATURE}`);
    }

    const mentionedUsers = await message.getMentions();
    if (mentionedUsers.length === 0) {
        return message.reply(`âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¥Ø´Ø§Ø±Ø© (mention) Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø¥Ø¶Ø§ÙØªÙ‡ ÙƒÙ…Ø·ÙˆØ±.${SIGNATURE}`);
    }

    for (const contact of mentionedUsers) {
        const userId = contact.id._serialized;
        const userName = contact.pushname || contact.name;
        try {
            const result = await db.addDeveloper(userId);
            if (result > 0) {
                state.admins.add(userId);
                await message.reply(`âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© "${userName}" Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø·ÙˆØ±ÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­!`);
            } else {
                await message.reply(`â„¹ï¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "${userName}" Ù‡Ùˆ Ù…Ø·ÙˆØ± Ø¨Ø§Ù„ÙØ¹Ù„.`);
            }
        } catch (error) {
            logError(error, 'handleAddDeveloper');
            await message.reply(`âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© "${userName}".`);
        }
    }
}

/**
 * @description ÙŠØ¹Ø±Ø¶ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ØªÙ‚Ù†ÙŠØ© Ø¹Ù† Ø§Ù„Ø¨ÙˆØª.
 * @param {Message} message - ÙƒØ§Ø¦Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø©.
 */
async function handleStats(message) {
     if (!isOwner(message.author || message.from)) {
        return message.reply(`âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± Ù…ØªØ§Ø­ Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·!${SIGNATURE}`);
    }

    const uptime = (Date.now() - state.startTime) / 1000; // Uptime in seconds
    const uptimeHours = Math.floor(uptime / 3600);
    const uptimeMinutes = Math.floor((uptime % 3600) / 60);

    const statsText = `
ğŸ“Š *Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¨ÙˆØª*

â±ï¸ *ÙˆÙ‚Øª Ø§Ù„ØªØ´ØºÙŠÙ„:* ${uptimeHours} Ø³Ø§Ø¹Ø© Ùˆ ${uptimeMinutes} Ø¯Ù‚ÙŠÙ‚Ø©
ğŸ§  *Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø°Ø§ÙƒØ±Ø©:* ${(process.memoryUsage().heapUsed / 1024 / 1024).toFixed(2)} MB
ğŸ‘¥ *Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø·ÙˆØ±ÙŠÙ†:* ${state.admins.size}
ğŸ“š *Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ø¹Ø¨ Ø§Ù„Ù…Ø­Ù…Ù„Ø©:* ${state.sections.size}
ğŸ« *Ø¹Ø¯Ø¯ Ø§Ù„ÙØµÙˆÙ„ Ø§Ù„Ù…Ø­Ù…Ù„Ø©:* ${state.classes.size}
    `;
    await message.reply(statsText + SIGNATURE);
}

/**
 * @description ÙŠØ¹ÙŠØ¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª.
 * @param {Message} message - ÙƒØ§Ø¦Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø©.
 */
async function handleRestart(message) {
    if (!isOwner(message.author || message.from)) {
        return message.reply(`âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± Ù…ØªØ§Ø­ Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·!${SIGNATURE}`);
    }
    
    await message.reply(`ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø¢Ù†...`);
    console.log('[ğŸ”„] Restarting bot by owner command...');
    
    // Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¹Ù„Ù‰ Ù…Ù†ØµØ§Øª Ù…Ø«Ù„ Render
    // Ù‡ÙŠ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ØŒ ÙˆØ³ØªÙ‚ÙˆÙ… Ø§Ù„Ù…Ù†ØµØ© Ø¨Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.
    process.exit(0);
}

module.exports = {
    '!Ø§Ø¶Ø§ÙØ©_Ù…Ø·ÙˆØ±': handleAddDeveloper,
    '!add_dev': handleAddDeveloper,
    '!Ø§Ø­ØµØ§Ø¦ÙŠØ§Øª': handleStats,
    '!stats': handleStats,
    '!Ø§Ø¹Ø§Ø¯Ø©_ØªØ´ØºÙŠÙ„': handleRestart,
    '!restart': handleRestart,
};
// commands/ai-commands.js

const { AI_API_KEY, SIGNATURE } = require('../config');
const { logError } = require('../utils');

/**
 * @description ÙŠØ±Ø³Ù„ Ø³Ø¤Ø§Ù„Ù‹Ø§ Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙˆÙŠØ¹ÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©.
 * @param {Message} message - ÙƒØ§Ø¦Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø©.
 * @param {Client} client - Ø¹Ù…ÙŠÙ„ ÙˆØ§ØªØ³Ø§Ø¨.
 */
async function handleAICommand(message, client) {
    const question = message.body.replace(/^!Ø³Ø¤Ø§Ù„|^!question/i, '').trim();
    
    if (!question) {
        await message.reply(`âš ï¸ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø³Ø¤Ø§Ù„Ùƒ Ø¨Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø±. Ù…Ø«Ø§Ù„: !Ø³Ø¤Ø§Ù„ Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠØŸ${SIGNATURE}`);
        return;
    }
    
    if (!AI_API_KEY || AI_API_KEY === 'YOUR_AI_API_KEY') {
        await message.reply(`âš ï¸ Ù„Ù… ÙŠØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ù…ÙØªØ§Ø­ API Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø§Ù„Ùƒ.${SIGNATURE}`);
        return;
    }
    
    await message.react('ğŸ¤–');
    
    try {
        // Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ API Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
        // Ù‡Ø°Ø§ Ù…Ø¬Ø±Ø¯ Ù…Ø«Ø§Ù„ØŒ ÙŠØ¬Ø¨ Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡ Ø¨Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„ÙØ¹Ù„ÙŠ
        
        // Ù…Ø«Ø§Ù„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… OpenAI API
        /*
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${AI_API_KEY}`
            },
            body: JSON.stringify({
                model: 'gpt-3.5-turbo',
                messages: [{ role: 'user', content: question }],
                max_tokens: 1000
            })
        });
        
        const data = await response.json();
        const answer = data.choices[0].message.content;
        */
        
        // Ù„Ù„ØªØ¬Ø±Ø¨Ø©ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø¥Ø¬Ø§Ø¨Ø© Ø«Ø§Ø¨ØªØ©
        const answer = `Ø£Ù†Ø§ Ø¨ÙˆØª ÙˆØ§ØªØ³Ø§Ø¨ Ø°ÙƒÙŠØŒ Ù„ÙƒÙ† Ù…ÙŠØ²Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù„Ø§ ØªØ²Ø§Ù„ Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±. Ø³Ø¤Ø§Ù„Ùƒ: "${question}"`;
        
        await message.reply(`ğŸ¤– *Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©:*\n\n${answer}${SIGNATURE}`);
    } catch (error) {
        logError(error, 'AI command');
        await message.reply(`âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø³Ø¤Ø§Ù„Ùƒ. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ù‹Ø§.${SIGNATURE}`);
    }
}

/**
 * @description ÙŠØªØ±Ø¬Ù… Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø±Ø³Ù„.
 * @param {Message} message - ÙƒØ§Ø¦Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø©.
 * @param {Client} client - Ø¹Ù…ÙŠÙ„ ÙˆØ§ØªØ³Ø§Ø¨.
 */
async function handleTranslateCommand(message, client) {
    const text = message.body.replace(/^!ØªØ±Ø¬Ù…Ø©|^!translate/i, '').trim();
    
    if (!text) {
        await message.reply(`âš ï¸ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù†Øµ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ ØªØ±Ø¬Ù…ØªÙ‡. Ù…Ø«Ø§Ù„: !ØªØ±Ø¬Ù…Ø© Hello world${SIGNATURE}`);
        return;
    }
    
    await message.react('ğŸŒ');
    
    try {
        // Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ API Ù„Ù„ØªØ±Ø¬Ù…Ø©
        // Ù‡Ø°Ø§ Ù…Ø¬Ø±Ø¯ Ù…Ø«Ø§Ù„ØŒ ÙŠØ¬Ø¨ Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡ Ø¨Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„ÙØ¹Ù„ÙŠ
        
        // Ù…Ø«Ø§Ù„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Google Translate API
        /*
        const response = await fetch(`https://translation.googleapis.com/language/translate/v2?key=${GOOGLE_API_KEY}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                q: text,
                target: 'ar'
            })
        });
        
        const data = await response.json();
        const translation = data.data.translations[0].translatedText;
        */
        
        // Ù„Ù„ØªØ¬Ø±Ø¨Ø©ØŒ Ù†Ø³ØªØ®Ø¯Ù… ØªØ±Ø¬Ù…Ø© Ø«Ø§Ø¨ØªØ©
        const translation = `Ø§Ù„ØªØ±Ø¬Ù…Ø©: "${text}" (Ù…ÙŠØ²Ø© Ø§Ù„ØªØ±Ø¬Ù…Ø© Ù„Ø§ ØªØ²Ø§Ù„ Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±)`;
        
        await message.reply(`ğŸŒ *Ø§Ù„ØªØ±Ø¬Ù…Ø©:*\n\n${translation}${SIGNATURE}`);
    } catch (error) {
        logError(error, 'translate command');
        await message.reply(`âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ±Ø¬Ù…Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ù‹Ø§.${SIGNATURE}`);
    }
}

/**
 * @description ÙŠÙ„Ø®Øµ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø±Ø³Ù„.
 * @param {Message} message - ÙƒØ§Ø¦Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø©.
 * @param {Client} client - Ø¹Ù…ÙŠÙ„ ÙˆØ§ØªØ³Ø§Ø¨.
 */
async function handleSummarizeCommand(message, client) {
    const text = message.body.replace(/^!ØªÙ„Ø®ÙŠØµ|^!summarize/i, '').trim();
    
    if (!text) {
        await message.reply(`âš ï¸ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù†Øµ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ ØªÙ„Ø®ÙŠØµÙ‡. Ù…Ø«Ø§Ù„: !ØªÙ„Ø®ÙŠØµ Ù†Øµ Ø·ÙˆÙŠÙ„ Ù‡Ù†Ø§...${SIGNATURE}`);
        return;
    }
    
    await message.react('ğŸ“');
    
    try {
        // Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ API Ù„Ù„ØªÙ„Ø®ÙŠØµ
        // Ù‡Ø°Ø§ Ù…Ø¬Ø±Ø¯ Ù…Ø«Ø§Ù„ØŒ ÙŠØ¬Ø¨ Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡ Ø¨Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„ÙØ¹Ù„ÙŠ
        
        // Ù„Ù„ØªØ¬Ø±Ø¨Ø©ØŒ Ù†Ø³ØªØ®Ø¯Ù… ØªÙ„Ø®ÙŠØµ Ø«Ø§Ø¨Øª
        const summary = `ØªÙ„Ø®ÙŠØµ: "${text.substring(0, 100)}..." (Ù…ÙŠØ²Ø© Ø§Ù„ØªÙ„Ø®ÙŠØµ Ù„Ø§ ØªØ²Ø§Ù„ Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±)`;
        
        await message.reply(`ğŸ“ *Ø§Ù„Ù…Ù„Ø®Øµ:*\n\n${summary}${SIGNATURE}`);
    } catch (error) {
        logError(error, 'summarize command');
        await message.reply(`âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙ„Ø®ÙŠØµ. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ù‹Ø§.${SIGNATURE}`);
    }
}

module.exports = {
    '!Ø³Ø¤Ø§Ù„': handleAICommand,
    '!question': handleAICommand,
    '!ØªØ±Ø¬Ù…Ø©': handleTranslateCommand,
    '!translate': handleTranslateCommand,
    '!ØªÙ„Ø®ÙŠØµ': handleSummarizeCommand,
    '!summarize': handleSummarizeCommand,
};
// commands/course-management.js

const state = require('../state');
const { saveData, updateData, deleteData } = require('../database');
const { SIGNATURE } = require('../config');
const { isAdmin } = require('../utils');

// =================================================================
// Handler Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ø¨Ø¯Ø¡ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‚Ø±Ø±Ø§Øª
// =================================================================

/**
 * @description ÙŠØ¨Ø¯Ø£ Ø¹Ù…Ù„ÙŠØ© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‚Ø±Ø±Ø§Øª Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©.
 * @param {Message} message - ÙƒØ§Ø¦Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù† whatsapp-web.js.
 * @param {Client} client - ÙƒØ§Ø¦Ù† Ø¹Ù…ÙŠÙ„ whatsapp-web.js.
 */
async function handleCoursesCommand(message, client) {
    const chat = await message.getChat();
    if (!chat.isGroup) {
        await message.reply(`âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± ÙŠØ¹Ù…Ù„ ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ÙÙ‚Ø·!${SIGNATURE}`);
        return;
    }

    const contact = await message.getContact();
    const authorId = contact.id._serialized;
    
    if (!(await isAdmin(client, authorId, chat.id._serialized))) {
        await message.reply(`âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± Ù…ØªØ§Ø­ Ù„Ù„Ù…Ø´Ø±ÙÙŠÙ† ÙÙ‚Ø·!${SIGNATURE}`);
        return;
    }
    
    await message.react('ğŸ“š');
    const senderName = contact.pushname || "Ø§Ù„Ù…Ø´Ø±Ù";
    const replyText = `
ğŸ“š *Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‚Ø±Ø±Ø§Øª Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©*

Ù…Ø±Ø­Ø¨Ø§Ù‹ ${senderName}! ğŸ™‹â€â™‚ï¸
ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø¥Ø¯Ø§Ø±ØªÙ‡:

1. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø¹Ø¨
2. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØµÙˆÙ„
3. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ÙÙˆØ§Ø¬
4. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©
5. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¯

ğŸ’¡ Ø£Ø±Ø³Ù„ Ø±Ù‚Ù… Ø§Ù„Ø®ÙŠØ§Ø± Ø£Ùˆ *Ø¥Ù„ØºØ§Ø¡* Ù„Ù„Ø®Ø±ÙˆØ¬.${SIGNATURE}`;
    
    await message.reply(replyText);
    state.userState.set(authorId, { 
        step: 'select_management_type', 
        timestamp: Date.now() 
    });
}

// =================================================================
// Ø¯ÙˆØ§Ù„ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±Ø¯ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø³ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§ Ù…Ù† state-handler.js)
// =================================================================

/**
 * @description ÙŠÙˆØ¬Ù‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ø®ØªÙŠØ§Ø±Ù‡.
 */
async function handleSelectManagementType(message) {
    const content = message.body.trim();
    const contact = await message.getContact();
    const authorId = contact.id._serialized;

    const managementMap = {
        '1': { handler: handleSectionsManagement, args: [] },
        '2': { handler: handleClassesManagement, args: [] },
        '3': { handler: handleGroupsManagement, args: [] },
        '4': { handler: handleProfessorsManagement, args: [] },
        '5': { handler: handleSubjectsManagement, args: [] },
    };

    if (managementMap[content]) {
        const { handler, args } = managementMap[content];
        await handler(message, ...args);
    } else {
        await message.reply(`âš ï¸ Ø®ÙŠØ§Ø± ØºÙŠØ± ØµØ§Ù„Ø­. ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù‚Ù… Ù…Ù† 1 Ø¥Ù„Ù‰ 5.${SIGNATURE}`);
    }
}

/**
 * @description Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø¹Ø¨ (Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ø´Ø¹Ø¨Ø© Ø£ÙˆÙ„Ø§Ù‹)
 */
async function handleSectionsManagement(message) {
    const contact = await message.getContact();
    const authorId = contact.id._serialized;
    
    await generateManagementMenu(message, 'Ø§Ù„Ø´Ø¹Ø¨', state.sections, 'sections_action');
}

/**
 * @description Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØµÙˆÙ„ (ÙŠØ¨Ø¯Ø£ Ø¨Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ø¹Ø¨Ø© Ø£ÙˆÙ„Ø§Ù‹)
 */
async function handleClassesManagement(message) {
    const contact = await message.getContact();
    const authorId = contact.id._serialized;
    
    // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø´Ø¹Ø¨ Ø£ÙˆÙ„Ø§Ù‹
    if (state.sections.size === 0) {
        await message.reply(`âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø¹Ø¨ Ù…Ø¶Ø§ÙØ© Ø¨Ø¹Ø¯. ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ø´Ø¹Ø¨ Ø£ÙˆÙ„Ø§Ù‹.${SIGNATURE}`);
        return;
    }
    
    let list = `ğŸ“‹ *Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¹Ø¨Ø© Ø£ÙˆÙ„Ø§Ù‹*\n\n`;
    let index = 1;
    for (const [id, name] of state.sections) {
        list += `${index}. ${name}\n`;
        index++;
    }
    
    const replyText = `
${list}

ğŸ’¡ Ø£Ø±Ø³Ù„ Ø±Ù‚Ù… Ø§Ù„Ø´Ø¹Ø¨Ø© Ø£Ùˆ *Ø¥Ù„ØºØ§Ø¡* Ù„Ù„Ø®Ø±ÙˆØ¬.${SIGNATURE}`;
    
    await message.reply(replyText);
    state.userState.set(authorId, { 
        step: 'select_section_for_classes', 
        timestamp: Date.now(),
        managementType: 'classes'
    });
}

/**
 * @description Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ÙÙˆØ§Ø¬ (ÙŠØ¨Ø¯Ø£ Ø¨Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ø¹Ø¨Ø© Ø«Ù… Ø§Ù„ÙØµÙ„)
 */
async function handleGroupsManagement(message) {
    const contact = await message.getContact();
    const authorId = contact.id._serialized;
    
    // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø´Ø¹Ø¨ Ø£ÙˆÙ„Ø§Ù‹
    if (state.sections.size === 0) {
        await message.reply(`âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø¹Ø¨ Ù…Ø¶Ø§ÙØ© Ø¨Ø¹Ø¯. ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ø´Ø¹Ø¨ Ø£ÙˆÙ„Ø§Ù‹.${SIGNATURE}`);
        return;
    }
    
    let list = `ğŸ“‹ *Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¹Ø¨Ø© Ø£ÙˆÙ„Ø§Ù‹*\n\n`;
    let index = 1;
    for (const [id, name] of state.sections) {
        list += `${index}. ${name}\n`;
        index++;
    }
    
    const replyText = `
${list}

ğŸ’¡ Ø£Ø±Ø³Ù„ Ø±Ù‚Ù… Ø§Ù„Ø´Ø¹Ø¨Ø© Ø£Ùˆ *Ø¥Ù„ØºØ§Ø¡* Ù„Ù„Ø®Ø±ÙˆØ¬.${SIGNATURE}`;
    
    await message.reply(replyText);
    state.userState.set(authorId, { 
        step: 'select_section_for_groups', 
        timestamp: Date.now(),
        managementType: 'groups'
    });
}

/**
 * @description Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© (ÙŠØ¨Ø¯Ø£ Ø¨Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ø¹Ø¨Ø© Ø«Ù… Ø§Ù„ÙØµÙ„)
 */
async function handleProfessorsManagement(message) {
    const contact = await message.getContact();
    const authorId = contact.id._serialized;
    
    // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø´Ø¹Ø¨ Ø£ÙˆÙ„Ø§Ù‹
    if (state.sections.size === 0) {
        await message.reply(`âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø¹Ø¨ Ù…Ø¶Ø§ÙØ© Ø¨Ø¹Ø¯. ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ø´Ø¹Ø¨ Ø£ÙˆÙ„Ø§Ù‹.${SIGNATURE}`);
        return;
    }
    
    let list = `ğŸ“‹ *Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¹Ø¨Ø© Ø£ÙˆÙ„Ø§Ù‹*\n\n`;
    let index = 1;
    for (const [id, name] of state.sections) {
        list += `${index}. ${name}\n`;
        index++;
    }
    
    const replyText = `
${list}

ğŸ’¡ Ø£Ø±Ø³Ù„ Ø±Ù‚Ù… Ø§Ù„Ø´Ø¹Ø¨Ø© Ø£Ùˆ *Ø¥Ù„ØºØ§Ø¡* Ù„Ù„Ø®Ø±ÙˆØ¬.${SIGNATURE}`;
    
    await message.reply(replyText);
    state.userState.set(authorId, { 
        step: 'select_section_for_professors', 
        timestamp: Date.now(),
        managementType: 'professors'
    });
}

/**
 * @description Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ (ÙŠØ¨Ø¯Ø£ Ø¨Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ø¹Ø¨Ø© Ø«Ù… Ø§Ù„ÙØµÙ„)
 */
async function handleSubjectsManagement(message) {
    const contact = await message.getContact();
    const authorId = contact.id._serialized;
    
    // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø´Ø¹Ø¨ Ø£ÙˆÙ„Ø§Ù‹
    if (state.sections.size === 0) {
        await message.reply(`âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø¹Ø¨ Ù…Ø¶Ø§ÙØ© Ø¨Ø¹Ø¯. ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ø´Ø¹Ø¨ Ø£ÙˆÙ„Ø§Ù‹.${SIGNATURE}`);
        return;
    }
    
    let list = `ğŸ“‹ *Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¹Ø¨Ø© Ø£ÙˆÙ„Ø§Ù‹*\n\n`;
    let index = 1;
    for (const [id, name] of state.sections) {
        list += `${index}. ${name}\n`;
        index++;
    }
    
    const replyText = `
${list}

ğŸ’¡ Ø£Ø±Ø³Ù„ Ø±Ù‚Ù… Ø§Ù„Ø´Ø¹Ø¨Ø© Ø£Ùˆ *Ø¥Ù„ØºØ§Ø¡* Ù„Ù„Ø®Ø±ÙˆØ¬.${SIGNATURE}`;
    
    await message.reply(replyText);
    state.userState.set(authorId, { 
        step: 'select_section_for_subjects', 
        timestamp: Date.now(),
        managementType: 'subjects'
    });
}

/**
 * @description Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ø¹Ø¨Ø© Ù„Ù„ÙØµÙˆÙ„
 */
async function handleSelectSectionForClasses(message) {
    const content = message.body.trim();
    const contact = await message.getContact();
    const authorId = contact.id._serialized;
    const userState = state.userState.get(authorId);
    
    const sectionIndex = parseInt(content) - 1;
    if (isNaN(sectionIndex) || sectionIndex < 0 || sectionIndex >= state.sections.size) {
        await message.reply(`âš ï¸ Ø±Ù‚Ù… ØºÙŠØ± ØµØ§Ù„Ø­. ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù‚Ù… Ù…Ù† 1 Ø¥Ù„Ù‰ ${state.sections.size}.${SIGNATURE}`);
        return;
    }
    
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ø´Ø¹Ø¨Ø©
    const sectionIds = Array.from(state.sections.keys());
    const sectionId = sectionIds[sectionIndex];
    const sectionName = state.sections.get(sectionId);
    
    // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØµÙˆÙ„ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø¹Ø¨Ø©
    const classesInSection = Array.from(state.classes).filter(([id, name]) => {
        // Ù‡Ù†Ø§ ÙŠØ¬Ø¨ Ø£Ù† Ù†Ø±Ù‰ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙØµÙ„ ÙŠÙ†ØªÙ…ÙŠ Ù„Ù„Ø´Ø¹Ø¨Ø©
        // ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØŒ ÙŠØ¬Ø¨ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        return true;
    });
    
    if (classesInSection.length === 0) {
        await message.reply(`âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØµÙˆÙ„ ÙÙŠ Ø´Ø¹Ø¨Ø© "${sectionName}".${SIGNATURE}`);
        state.userState.delete(authorId);
        return;
    }
    
    let list = `ğŸ“‹ *Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„ ÙÙŠ Ø´Ø¹Ø¨Ø© "${sectionName}"*\n\n`;
    let index = 1;
    for (const [id, name] of classesInSection) {
        list += `${index}. ${name}\n`;
        index++;
    }
    
    const replyText = `
${list}

ğŸ’¡ Ø£Ø±Ø³Ù„ Ø±Ù‚Ù… Ø§Ù„ÙØµÙ„ Ø£Ùˆ *Ø¥Ù„ØºØ§Ø¡* Ù„Ù„Ø®Ø±ÙˆØ¬.${SIGNATURE}`;
    
    await message.reply(replyText);
    userState.step = 'select_class_for_management';
    userState.sectionId = sectionId;
    userState.sectionName = sectionName;
    userState.classes = classesInSection;
    state.userState.set(authorId, userState);
}

/**
 * @description Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ø¹Ø¨Ø© Ù„Ù„Ø£ÙÙˆØ§Ø¬
 */
async function handleSelectSectionForGroups(message) {
    const content = message.body.trim();
    const contact = await message.getContact();
    const authorId = contact.id._serialized;
    const userState = state.userState.get(authorId);
    
    const sectionIndex = parseInt(content) - 1;
    if (isNaN(sectionIndex) || sectionIndex < 0 || sectionIndex >= state.sections.size) {
        await message.reply(`âš ï¸ Ø±Ù‚Ù… ØºÙŠØ± ØµØ§Ù„Ø­. ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù‚Ù… Ù…Ù† 1 Ø¥Ù„Ù‰ ${state.sections.size}.${SIGNATURE}`);
        return;
    }
    
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ø´Ø¹Ø¨Ø©
    const sectionIds = Array.from(state.sections.keys());
    const sectionId = sectionIds[sectionIndex];
    const sectionName = state.sections.get(sectionId);
    
    // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØµÙˆÙ„ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø¹Ø¨Ø©
    const classesInSection = Array.from(state.classes).filter(([id, name]) => {
        return true;
    });
    
    if (classesInSection.length === 0) {
        await message.reply(`âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØµÙˆÙ„ ÙÙŠ Ø´Ø¹Ø¨Ø© "${sectionName}".${SIGNATURE}`);
        state.userState.delete(authorId);
        return;
    }
    
    let list = `ğŸ“‹ *Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¹Ø¨Ø© "${sectionName}" Ø«Ù… Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„*\n\n`;
    let index = 1;
    for (const [id, name] of classesInSection) {
        list += `${index}. ${name}\n`;
        index++;
    }
    
    const replyText = `
${list}

ğŸ’¡ Ø£Ø±Ø³Ù„ Ø±Ù‚Ù… Ø§Ù„ÙØµÙ„ Ø£Ùˆ *Ø¥Ù„ØºØ§Ø¡* Ù„Ù„Ø®Ø±ÙˆØ¬.${SIGNATURE}`;
    
    await message.reply(replyText);
    userState.step = 'select_class_for_groups';
    userState.sectionId = sectionId;
    userState.sectionName = sectionName;
    userState.classes = classesInSection;
    state.userState.set(authorId, userState);
}

/**
 * @description Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ø¹Ø¨Ø© Ù„Ù„Ø£Ø³Ø§ØªØ°Ø©
 */
async function handleSelectSectionForProfessors(message) {
    const content = message.body.trim();
    const contact = await message.getContact();
    const authorId = contact.id._serialized;
    const userState = state.userState.get(authorId);
    
    const sectionIndex = parseInt(content) - 1;
    if (isNaN(sectionIndex) || sectionIndex < 0 || sectionIndex >= state.sections.size) {
        await message.reply(`âš ï¸ Ø±Ù‚Ù… ØºÙŠØ± ØµØ§Ù„Ø­. ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù‚Ù… Ù…Ù† 1 Ø¥Ù„Ù‰ ${state.sections.size}.${SIGNATURE}`);
        return;
    }
    
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ø´Ø¹Ø¨Ø©
    const sectionIds = Array.from(state.sections.keys());
    const sectionId = sectionIds[sectionIndex];
    const sectionName = state.sections.get(sectionId);
    
    // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØµÙˆÙ„ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø¹Ø¨Ø©
    const classesInSection = Array.from(state.classes).filter(([id, name]) => {
        return true;
    });
    
    if (classesInSection.length === 0) {
        await message.reply(`âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØµÙˆÙ„ ÙÙŠ Ø´Ø¹Ø¨Ø© "${sectionName}".${SIGNATURE}`);
        state.userState.delete(authorId);
        return;
    }
    
    let list = `ğŸ“‹ *Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¹Ø¨Ø© "${sectionName}" Ø«Ù… Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„*\n\n`;
    let index = 1;
    for (const [id, name] of classesInSection) {
        list += `${index}. ${name}\n`;
        index++;
    }
    
    const replyText = `
${list}

ğŸ’¡ Ø£Ø±Ø³Ù„ Ø±Ù‚Ù… Ø§Ù„ÙØµÙ„ Ø£Ùˆ *Ø¥Ù„ØºØ§Ø¡* Ù„Ù„Ø®Ø±ÙˆØ¬.${SIGNATURE}`;
    
    await message.reply(replyText);
    userState.step = 'select_class_for_professors';
    userState.sectionId = sectionId;
    userState.sectionName = sectionName;
    userState.classes = classesInSection;
    state.userState.set(authorId, userState);
}

/**
 * @description Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ø¹Ø¨Ø© Ù„Ù„Ù…ÙˆØ§Ø¯
 */
async function handleSelectSectionForSubjects(message) {
    const content = message.body.trim();
    const contact = await message.getContact();
    const authorId = contact.id._serialized;
    const userState = state.userState.get(authorId);
    
    const sectionIndex = parseInt(content) - 1;
    if (isNaN(sectionIndex) || sectionIndex < 0 || sectionIndex >= state.sections.size) {
        await message.reply(`âš ï¸ Ø±Ù‚Ù… ØºÙŠØ± ØµØ§Ù„Ø­. ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù‚Ù… Ù…Ù† 1 Ø¥Ù„Ù‰ ${state.sections.size}.${SIGNATURE}`);
        return;
    }
    
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ø´Ø¹Ø¨Ø©
    const sectionIds = Array.from(state.sections.keys());
    const sectionId = sectionIds[sectionIndex];
    const sectionName = state.sections.get(sectionId);
    
    // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØµÙˆÙ„ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø¹Ø¨Ø©
    const classesInSection = Array.from(state.classes).filter(([id, name]) => {
        return true;
    });
    
    if (classesInSection.length === 0) {
        await message.reply(`âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØµÙˆÙ„ ÙÙŠ Ø´Ø¹Ø¨Ø© "${sectionName}".${SIGNATURE}`);
        state.userState.delete(authorId);
        return;
    }
    
    let list = `ğŸ“‹ *Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¹Ø¨Ø© "${sectionName}" Ø«Ù… Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„*\n\n`;
    let index = 1;
    for (const [id, name] of classesInSection) {
        list += `${index}. ${name}\n`;
        index++;
    }
    
    const replyText = `
${list}

ğŸ’¡ Ø£Ø±Ø³Ù„ Ø±Ù‚Ù… Ø§Ù„ÙØµÙ„ Ø£Ùˆ *Ø¥Ù„ØºØ§Ø¡* Ù„Ù„Ø®Ø±ÙˆØ¬.${SIGNATURE}`;
    
    await message.reply(replyText);
    userState.step = 'select_class_for_subjects';
    userState.sectionId = sectionId;
    userState.sectionName = sectionName;
    userState.classes = classesInSection;
    state.userState.set(authorId, userState);
}

/**
 * @description Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØµÙ„ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©
 */
async function handleSelectClassForManagement(message) {
    const content = message.body.trim();
    const contact = await message.getContact();
    const authorId = contact.id._serialized;
    const userState = state.userState.get(authorId);
    
    const classIndex = parseInt(content) - 1;
    if (isNaN(classIndex) || classIndex < 0 || classIndex >= userState.classes.length) {
        await message.reply(`âš ï¸ Ø±Ù‚Ù… ØºÙŠØ± ØµØ§Ù„Ø­. ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù‚Ù… Ù…Ù† 1 Ø¥Ù„Ù‰ ${userState.classes.length}.${SIGNATURE}`);
        return;
    }
    
    const [classId, className] = userState.classes[classIndex];
    
    // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØµÙˆÙ„ ÙÙŠ Ø§Ù„Ø´Ø¹Ø¨Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
    await generateManagementMenu(message, `Ø§Ù„ÙØµÙˆÙ„ ÙÙŠ Ø´Ø¹Ø¨Ø© "${userState.sectionName}"`, userState.classes, 'classes_action');
    
    userState.classId = classId;
    userState.className = className;
    state.userState.set(authorId, userState);
}

/**
 * @description Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØµÙ„ Ù„Ù„Ø£ÙÙˆØ§Ø¬
 */
async function handleSelectClassForGroups(message) {
    const content = message.body.trim();
    const contact = await message.getContact();
    const authorId = contact.id._serialized;
    const userState = state.userState.get(authorId);
    
    const classIndex = parseInt(content) - 1;
    if (isNaN(classIndex) || classIndex < 0 || classIndex >= userState.classes.length) {
        await message.reply(`âš ï¸ Ø±Ù‚Ù… ØºÙŠØ± ØµØ§Ù„Ø­. ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù‚Ù… Ù…Ù† 1 Ø¥Ù„Ù‰ ${userState.classes.length}.${SIGNATURE}`);
        return;
    }
    
    const [classId, className] = userState.classes[classIndex];
    
    // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙÙˆØ§Ø¬ ÙÙŠ Ø§Ù„ÙØµÙ„ Ø§Ù„Ù…Ø®ØªØ§Ø±
    const groupsInClass = Array.from(state.groupsData).filter(([id, name]) => {
        // Ù‡Ù†Ø§ ÙŠØ¬Ø¨ Ø£Ù† Ù†Ø±Ù‰ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© ØªÙ†ØªÙ…ÙŠ Ù„Ù„ÙØµÙ„
        return true;
    });
    
    if (groupsInClass.length === 0) {
        await message.reply(`âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙÙˆØ§Ø¬ ÙÙŠ ÙØµÙ„ "${className}".${SIGNATURE}`);
        state.userState.delete(authorId);
        return;
    }
    
    await generateManagementMenu(message, `Ø§Ù„Ø£ÙÙˆØ§Ø¬ ÙÙŠ ÙØµÙ„ "${className}"`, groupsInClass, 'groups_action');
    
    userState.classId = classId;
    userState.className = className;
    userState.groups = groupsInClass;
    state.userState.set(authorId, userState);
}

/**
 * @description Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØµÙ„ Ù„Ù„Ø£Ø³Ø§ØªØ°Ø©
 */
async function handleSelectClassForProfessors(message) {
    const content = message.body.trim();
    const contact = await message.getContact();
    const authorId = contact.id._serialized;
    const userState = state.userState.get(authorId);
    
    const classIndex = parseInt(content) - 1;
    if (isNaN(classIndex) || classIndex < 0 || classIndex >= userState.classes.length) {
        await message.reply(`âš ï¸ Ø±Ù‚Ù… ØºÙŠØ± ØµØ§Ù„Ø­. ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù‚Ù… Ù…Ù† 1 Ø¥Ù„Ù‰ ${userState.classes.length}.${SIGNATURE}`);
        return;
    }
    
    const [classId, className] = userState.classes[classIndex];
    
    // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© ÙÙŠ Ø§Ù„ÙØµÙ„ Ø§Ù„Ù…Ø®ØªØ§Ø±
    const professorsInClass = Array.from(state.professors).filter(([id, name]) => {
        // Ù‡Ù†Ø§ ÙŠØ¬Ø¨ Ø£Ù† Ù†Ø±Ù‰ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø£Ø³ØªØ§Ø° ÙŠØ¯Ø±Ø³ ÙÙŠ Ø§Ù„ÙØµÙ„
        return true;
    });
    
    if (professorsInClass.length === 0) {
        await message.reply(`âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø§ØªØ°Ø© ÙÙŠ ÙØµÙ„ "${className}".${SIGNATURE}`);
        state.userState.delete(authorId);
        return;
    }
    
    await generateManagementMenu(message, `Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© ÙÙŠ ÙØµÙ„ "${className}"`, professorsInClass, 'professors_action');
    
    userState.classId = classId;
    userState.className = className;
    userState.professors = professorsInClass;
    state.userState.set(authorId, userState);
}

/**
 * @description Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØµÙ„ Ù„Ù„Ù…ÙˆØ§Ø¯
 */
async function handleSelectClassForSubjects(message) {
    const content = message.body.trim();
    const contact = await message.getContact();
    const authorId = contact.id._serialized;
    const userState = state.userState.get(authorId);
    
    const classIndex = parseInt(content) - 1;
    if (isNaN(classIndex) || classIndex < 0 || classIndex >= userState.classes.length) {
        await message.reply(`âš ï¸ Ø±Ù‚Ù… ØºÙŠØ± ØµØ§Ù„Ø­. ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù‚Ù… Ù…Ù† 1 Ø¥Ù„Ù‰ ${userState.classes.length}.${SIGNATURE}`);
        return;
    }
    
    const [classId, className] = userState.classes[classIndex];
    
    // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ ÙÙŠ Ø§Ù„ÙØµÙ„ Ø§Ù„Ù…Ø®ØªØ§Ø±
    const subjectsInClass = Array.from(state.subjects).filter(([id, name]) => {
        // Ù‡Ù†Ø§ ÙŠØ¬Ø¨ Ø£Ù† Ù†Ø±Ù‰ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø§Ø¯Ø© ØªÙ†ØªÙ…ÙŠ Ù„Ù„ÙØµÙ„
        return true;
    });
    
    if (subjectsInClass.length === 0) {
        await message.reply(`âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯ ÙÙŠ ÙØµÙ„ "${className}".${SIGNATURE}`);
        state.userState.delete(authorId);
        return;
    }
    
    await generateManagementMenu(message, `Ø§Ù„Ù…ÙˆØ§Ø¯ ÙÙŠ ÙØµÙ„ "${className}"`, subjectsInClass, 'subjects_action');
    
    userState.classId = classId;
    userState.className = className;
    userState.subjects = subjectsInClass;
    state.userState.set(authorId, userState);
}

/**
 * @description Ø¯Ø§Ù„Ø© Ø¹Ø§Ù…Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ø¹Ø±Ø¶ØŒ Ø¥Ø¶Ø§ÙØ©ØŒ ØªØ¹Ø¯ÙŠÙ„ØŒ Ø­Ø°Ù).
 */
async function generateManagementMenu(message, typeName, dataMap, nextStep) {
    let list = `ğŸ“‹ *Ù‚Ø§Ø¦Ù…Ø© ${typeName}*\n\n`;
    if (dataMap.size === 0) {
        list += `Ù„Ø§ ØªÙˆØ¬Ø¯ ${typeName} Ù…Ø¶Ø§ÙØ© Ø¨Ø¹Ø¯.`;
    } else {
        let index = 1;
        for (const [id, name] of dataMap) {
            list += `${index}. ${name} (Ø§Ù„Ù…Ø¹Ø±Ù: ${id})\n`;
            index++;
        }
    }

    const replyText = `
${list}

---
Ù…Ø§Ø°Ø§ ØªØ±ÙŠØ¯ Ø£Ù† ØªÙØ¹Ù„ØŸ
1. Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
2. Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± Ø¬Ø¯ÙŠØ¯
3. ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù†ØµØ±
4. Ø­Ø°Ù Ø¹Ù†ØµØ±

ğŸ’¡ Ø£Ø±Ø³Ù„ Ø±Ù‚Ù… Ø§Ù„Ø®ÙŠØ§Ø± Ø£Ùˆ *Ø¥Ù„ØºØ§Ø¡* Ù„Ù„Ø®Ø±ÙˆØ¬.${SIGNATURE}`;
    
    await message.reply(replyText);
    const contact = await message.getContact();
    const authorId = contact.id._serialized;
    
    state.userState.set(authorId, { 
        step: nextStep, 
        timestamp: Date.now(),
        // Ù†Ø®Ø²Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø§Ø²Ù…Ø© Ù„Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©
        dataType: typeName,
        dataMap: dataMap,
        dbTable: typeName === 'Ø§Ù„Ø£ÙÙˆØ§Ø¬' ? 'groups' : typeName.slice(0, -1), // Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    });
}

/**
 * @description Ø¯Ø§Ù„Ø© Ø¹Ø§Ù…Ø© Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª (Ø¹Ø±Ø¶ØŒ Ø¥Ø¶Ø§ÙØ©ØŒ ØªØ¹Ø¯ÙŠÙ„ØŒ Ø­Ø°Ù).
 */
async function handleGenericAction(message) {
    const content = message.body.trim();
    const contact = await message.getContact();
    const authorId = contact.id._serialized;
    const userState = state.userState.get(authorId);

    const { dataType, dataMap, dbTable } = userState;
    
    if (content === '1') { // Ø¹Ø±Ø¶
        // ØªÙ… Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©ØŒ Ù„Ø°Ø§ Ù†Ù†Ù‡ÙŠ Ø§Ù„Ø¬Ù„Ø³Ø©
        await message.reply(`âœ… ØªÙ… Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© ${dataType}.${SIGNATURE}`);
        state.userState.delete(authorId);
    } 
    else if (content === '2') { // Ø¥Ø¶Ø§ÙØ©
        await message.reply(`ğŸ“ *Ø¥Ø¶Ø§ÙØ© ${dataType.slice(0, -1)} Ø¬Ø¯ÙŠØ¯*\n\nÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø§Ø³Ù… ${dataType.slice(0, -1)} Ø§Ù„Ø¬Ø¯ÙŠØ¯:${SIGNATURE}`);
        userState.step = 'add_new_item';
        state.userState.set(authorId, userState);
    } 
    else if (content === '3') { // ØªØ¹Ø¯ÙŠÙ„
        if (dataMap.size === 0) {
            await message.reply(`âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ${dataType} Ù„ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§.${SIGNATURE}`);
            state.userState.delete(authorId);
            return;
        }
        
        let list = `ğŸ“‹ *Ø§Ø®ØªØ± ${dataType.slice(0, -1)} Ù„Ù„ØªØ¹Ø¯ÙŠÙ„*\n\n`;
        let index = 1;
        for (const [id, name] of dataMap) {
            list += `${index}. ${name}\n`;
            index++;
        }
        
        list += `\nğŸ’¡ Ø£Ø±Ø³Ù„ Ø±Ù‚Ù… ${dataType.slice(0, -1)} Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ ØªØ¹Ø¯ÙŠÙ„Ù‡ Ø£Ùˆ *Ø¥Ù„ØºØ§Ø¡* Ù„Ù„Ø®Ø±ÙˆØ¬.${SIGNATURE}`;
        await message.reply(list);
        
        userState.step = 'select_item_to_edit';
        state.userState.set(authorId, userState);
    } 
    else if (content === '4') { // Ø­Ø°Ù
        if (dataMap.size === 0) {
            await message.reply(`âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ${dataType} Ù„Ø­Ø°ÙÙ‡Ø§.${SIGNATURE}`);
            state.userState.delete(authorId);
            return;
        }
        
        let list = `ğŸ—‘ï¸ *Ø§Ø®ØªØ± ${dataType.slice(0, -1)} Ù„Ù„Ø­Ø°Ù*\n\n`;
        let index = 1;
        for (const [id, name] of dataMap) {
            list += `${index}. ${name}\n`;
            index++;
        }
        
        list += `\nğŸ’¡ Ø£Ø±Ø³Ù„ Ø±Ù‚Ù… ${dataType.slice(0, -1)} Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø­Ø°ÙÙ‡ Ø£Ùˆ *Ø¥Ù„ØºØ§Ø¡* Ù„Ù„Ø®Ø±ÙˆØ¬.${SIGNATURE}`;
        await message.reply(list);
        
        userState.step = 'select_item_to_delete';
        state.userState.set(authorId, userState);
    } 
    else {
        await message.reply(`âš ï¸ Ø®ÙŠØ§Ø± ØºÙŠØ± ØµØ§Ù„Ø­. ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù‚Ù… Ù…Ù† 1 Ø¥Ù„Ù‰ 4.${SIGNATURE}`);
    }
}

/**
 * @description ÙŠØ¶ÙŠÙ Ø¹Ù†ØµØ±Ù‹Ø§ Ø¬Ø¯ÙŠØ¯Ù‹Ø§ (Ø´Ø¹Ø¨Ø©ØŒ ÙØµÙ„ØŒ Ù…Ø¬Ù…ÙˆØ¹Ø©ØŒ Ø£Ø³ØªØ§Ø°ØŒ Ù…Ø§Ø¯Ø©).
 */
async function handleAddNewItem(message) {
    const contact = await message.getContact();
    const authorId = contact.id._serialized;
    const userState = state.userState.get(authorId);
    const { dataType, dbTable } = userState;
    
    const itemName = message.body.trim();
    if (!itemName) {
        await message.reply(`âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø§Ø³Ù… ${dataType.slice(0, -1)} ØµØ§Ù„Ø­.${SIGNATURE}`);
        return;
    }
    
    try {
        // ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø«Ø§Ù„ØŒ Ø³Ù†Ø³ØªØ®Ø¯Ù… Ø¯Ø§Ù„Ø© saveData Ø§Ù„Ù…ÙØªØ±Ø¶Ø© ÙÙŠ database.js
        // Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ Ù„ÙŠÙ†Ø§Ø³Ø¨ Ù‡ÙŠÙƒÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ¹Ù„ÙŠ
        const newItemId = await saveData(dbTable, { name: itemName });
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
        userState.dataMap.set(newItemId, itemName);
        
        await message.reply(`âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${dataType.slice(0, -1)} "${itemName}" Ø¨Ù†Ø¬Ø§Ø­.${SIGNATURE}`);
        state.userState.delete(authorId);
    } catch (error) {
        console.error(`[âŒ] Error adding ${dataType.slice(0, -1)}:`, error);
        await message.reply(`âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© ${dataType.slice(0, -1)}.${SIGNATURE}`);
        state.userState.delete(authorId);
    }
}

/**
 * @description ÙŠØ¹Ø¯Ù„ Ø¹Ù†ØµØ±Ù‹Ø§ Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§.
 */
async function handleSelectItemToEdit(message) {
    const contact = await message.getContact();
    const authorId = contact.id._serialized;
    const userState = state.userState.get(authorId);
    const { dataType, dataMap } = userState;
    
    const itemIndex = parseInt(message.body.trim()) - 1;
    if (isNaN(itemIndex) || itemIndex < 0 || itemIndex >= dataMap.size) {
        await message.reply(`âš ï¸ Ø±Ù‚Ù… ØºÙŠØ± ØµØ§Ù„Ø­. ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù‚Ù… Ù…Ù† 1 Ø¥Ù„Ù‰ ${dataMap.size}.${SIGNATURE}`);
        return;
    }
    
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø­Ø¯Ø¯
    const itemIds = Array.from(dataMap.keys());
    const itemId = itemIds[itemIndex];
    const currentName = dataMap.get(itemId);
    
    await message.reply(`ğŸ“ *ØªØ¹Ø¯ÙŠÙ„ ${dataType.slice(0, -1)}*\n\nØ§Ù„Ø§Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ: ${currentName}\n\nÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:${SIGNATURE}`);
    
    userState.selectedItemId = itemId;
    userState.step = 'edit_item';
    state.userState.set(authorId, userState);
}

/**
 * @description ÙŠØ­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†ØµØ±.
 */
async function handleEditItem(message) {
    const contact = await message.getContact();
    const authorId = contact.id._serialized;
    const userState = state.userState.get(authorId);
    const { dataType, dbTable, selectedItemId } = userState;
    
    const newName = message.body.trim();
    if (!newName) {
        await message.reply(`âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø§Ø³Ù… ${dataType.slice(0, -1)} ØµØ§Ù„Ø­.${SIGNATURE}`);
        return;
    }
    
    try {
        // ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø«Ø§Ù„ØŒ Ø³Ù†Ø³ØªØ®Ø¯Ù… Ø¯Ø§Ù„Ø© updateData Ø§Ù„Ù…ÙØªØ±Ø¶Ø© ÙÙŠ database.js
        // Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ Ù„ÙŠÙ†Ø§Ø³Ø¨ Ù‡ÙŠÙƒÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ¹Ù„ÙŠ
        await updateData(dbTable, selectedItemId, { name: newName });
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
        userState.dataMap.set(selectedItemId, newName);
        
        await message.reply(`âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ ${dataType.slice(0, -1)} Ø¨Ù†Ø¬Ø§Ø­.${SIGNATURE}`);
        state.userState.delete(authorId);
    } catch (error) {
        console.error(`[âŒ] Error editing ${dataType.slice(0, -1)}:`, error);
        await message.reply(`âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ¹Ø¯ÙŠÙ„ ${dataType.slice(0, -1)}.${SIGNATURE}`);
        state.userState.delete(authorId);
    }
}

/**
 * @description ÙŠØ­Ø°Ù Ø¹Ù†ØµØ±Ù‹Ø§ Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§.
 */
async function handleSelectItemToDelete(message) {
    const contact = await message.getContact();
    const authorId = contact.id._serialized;
    const userState = state.userState.get(authorId);
    const { dataType, dataMap } = userState;
    
    const itemIndex = parseInt(message.body.trim()) - 1;
    if (isNaN(itemIndex) || itemIndex < 0 || itemIndex >= dataMap.size) {
        await message.reply(`âš ï¸ Ø±Ù‚Ù… ØºÙŠØ± ØµØ§Ù„Ø­. ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù‚Ù… Ù…Ù† 1 Ø¥Ù„Ù‰ ${dataMap.size}.${SIGNATURE}`);
        return;
    }
    
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø­Ø¯Ø¯
    const itemIds = Array.from(dataMap.keys());
    const itemId = itemIds[itemIndex];
    const itemName = dataMap.get(itemId);
    
    await message.reply(`âš ï¸ *ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù*\n\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ${dataType.slice(0, -1)} "${itemName}"ØŸ\n\nØ£Ø±Ø³Ù„ "Ù†Ø¹Ù…" Ù„Ù„ØªØ£ÙƒÙŠØ¯ Ø£Ùˆ Ø£ÙŠ Ø±Ø³Ø§Ù„Ø© Ø£Ø®Ø±Ù‰ Ù„Ù„Ø¥Ù„ØºØ§Ø¡.${SIGNATURE}`);
    
    userState.selectedItemId = itemId;
    userState.step = 'delete_item';
    state.userState.set(authorId, userState);
}

/**
 * @description ÙŠÙ†ÙØ° Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ± Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯.
 */
async function handleDeleteItem(message) {
    const contact = await message.getContact();
    const authorId = contact.id._serialized;
    const userState = state.userState.get(authorId);
    const { dataType, dbTable, selectedItemId, dataMap } = userState;
    
    if (message.body.trim().toLowerCase() !== 'Ù†Ø¹Ù…') {
        await message.reply(`âœ… ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø°Ù.${SIGNATURE}`);
        state.userState.delete(authorId);
        return;
    }
    
    try {
        // ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø«Ø§Ù„ØŒ Ø³Ù†Ø³ØªØ®Ø¯Ù… Ø¯Ø§Ù„Ø© deleteData Ø§Ù„Ù…ÙØªØ±Ø¶Ø© ÙÙŠ database.js
        // Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ Ù„ÙŠÙ†Ø§Ø³Ø¨ Ù‡ÙŠÙƒÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ¹Ù„ÙŠ
        await deleteData(dbTable, selectedItemId);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
        const itemName = dataMap.get(selectedItemId);
        dataMap.delete(selectedItemId);
        
        await message.reply(`âœ… ØªÙ… Ø­Ø°Ù ${dataType.slice(0, -1)} "${itemName}" Ø¨Ù†Ø¬Ø§Ø­.${SIGNATURE}`);
        state.userState.delete(authorId);
    } catch (error) {
        console.error(`[âŒ] Error deleting ${dataType.slice(0, -1)}:`, error);
        await message.reply(`âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù ${dataType.slice(0, -1)}.${SIGNATURE}`);
        state.userState.delete(authorId);
    }
}

// =================================================================
// ØªØµØ¯ÙŠØ± Ø§Ù„Ø£ÙˆØ§Ù…Ø±
// =================================================================

module.exports = {
    '!Ù…Ù‚Ø±Ø±Ø§Øª': handleCoursesCommand,
    '!courses': handleCoursesCommand,
    
    // Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø³ØªØ³ØªØ®Ø¯Ù… ÙÙŠ state-handler.js
    handleSelectManagementType,
    handleSectionsManagement,
    handleClassesManagement,
    handleGroupsManagement,
    handleProfessorsManagement,
    handleSubjectsManagement,
    handleSelectSectionForClasses,
    handleSelectSectionForGroups,
    handleSelectSectionForProfessors,
    handleSelectSectionForSubjects,
    handleSelectClassForManagement,
    handleSelectClassForGroups,
    handleSelectClassForProfessors,
    handleSelectClassForSubjects,
    handleGenericAction,
    handleAddNewItem,
    handleSelectItemToEdit,
    handleEditItem,
    handleSelectItemToDelete,
    handleDeleteItem,
};
// commands/lecture-commands.js

const { isAdmin } = require('../utils');
const { SIGNATURE } = require('../config');
const state = require('../state');
const { addLecture } = require('../utils');
const db = require('../database');

/**
 * @description ÙŠØ¨Ø¯Ø£ Ø¹Ù…Ù„ÙŠØ© Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ø§Ø¶Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©.
 * @param {Message} message - ÙƒØ§Ø¦Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù† whatsapp-web.js.
 * @param {Client} client - ÙƒØ§Ø¦Ù† Ø¹Ù…ÙŠÙ„ whatsapp-web.js.
 */
async function handleAddLectureCommand(message, client) {
    const chat = await message.getChat();
    if (!chat.isGroup) {
        await message.reply(`âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± ÙŠØ¹Ù…Ù„ ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ÙÙ‚Ø·!${SIGNATURE}`);
        return;
    }

    const contact = await message.getContact();
    const authorId = contact.id._serialized;
    
    if (!(await isAdmin(client, authorId, chat.id._serialized))) {
        await message.reply(`âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± Ù…ØªØ§Ø­ Ù„Ù„Ù…Ø´Ø±ÙÙŠÙ† ÙÙ‚Ø·!${SIGNATURE}`);
        return;
    }
    
    await message.react('ğŸ“š');
    const senderName = contact.pushname || "Ø§Ù„Ù…Ø´Ø±Ù";
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø´Ø¹Ø¨
    if (state.sections.size === 0) {
        await message.reply(`âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø¹Ø¨ Ù…Ø¶Ø§ÙØ© Ø¨Ø¹Ø¯. ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ø´Ø¹Ø¨Ø© Ø£ÙˆÙ„Ø§Ù‹.${SIGNATURE}`);
        return;
    }
    
    const replyText = `
ğŸ“š *Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ø§Ø¶Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©*

Ù…Ø±Ø­Ø¨Ø§Ù‹ ${senderName}! ğŸ™‹â€â™‚ï¸
Ø³Ø£Ù‚ÙˆÙ… Ø¨ØªÙˆØ¬ÙŠÙ‡Ùƒ Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ© Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ø§Ø¶Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©.

ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ø¹Ø¨Ø©:
`;

    let list = '';
    let index = 1;
    for (const [id, name] of state.sections) {
        list += `${index}. ${name}\n`;
        index++;
    }

    await message.reply(replyText + list + `\nğŸ’¡ Ø£Ø±Ø³Ù„ Ø±Ù‚Ù… Ø§Ù„Ø´Ø¹Ø¨Ø© Ø£Ùˆ *Ø¥Ù„ØºØ§Ø¡* Ù„Ù„Ø®Ø±ÙˆØ¬.${SIGNATURE}`);
    
    state.userState.set(authorId, { 
        step: 'add_lecture_select_section', 
        timestamp: Date.now(),
        lectureData: {}
    });
}

/**
 * @description ÙŠØ¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©.
 * @param {Message} message - ÙƒØ§Ø¦Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù† whatsapp-web.js.
 * @param {Client} client - ÙƒØ§Ø¦Ù† Ø¹Ù…ÙŠÙ„ whatsapp-web.js.
 */
async function handleListLecturesCommand(message, client) {
    const chat = await message.getChat();
    if (!chat.isGroup) {
        await message.reply(`âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± ÙŠØ¹Ù…Ù„ ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ÙÙ‚Ø·!${SIGNATURE}`);
        return;
    }

    await message.react('ğŸ“‹');
    
    try {
        const lectures = await db.getAllLectures();
        
        if (lectures.length === 0) {
            await message.reply(`âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ù…Ø¶Ø§ÙØ© Ø¨Ø¹Ø¯.${SIGNATURE}`);
            return;
        }
        
        let list = `ğŸ“‹ *Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª*\n\n`;
        lectures.forEach((lecture, index) => {
            const date = lecture.created_at ? 
                new Date(lecture.created_at).toLocaleDateString('ar-EG') : 
                'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            list += `${index + 1}. ${lecture.section_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} - ${lecture.class_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\n`;
            list += `   Ø§Ù„Ù…Ø§Ø¯Ø©: ${lecture.subject_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\n`;
            list += `   Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©: ${lecture.lecture_number || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\n`;
            list += `   Ø§Ù„Ø£Ø³ØªØ§Ø°: ${lecture.professor_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\n`;
            list += `   Ø§Ù„ØªØ§Ø±ÙŠØ®: ${date}\n\n`;
        });
        
        await message.reply(list + SIGNATURE);
    } catch (error) {
        console.error('[âŒ] Error listing lectures:', error);
        await message.reply(`âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª.${SIGNATURE}`);
    }
}

/**
 * @description ÙŠÙ†Ø´Ø¦ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª ÙƒÙ…Ù„Ù PDF.
 * @param {Message} message - ÙƒØ§Ø¦Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù† whatsapp-web.js.
 * @param {Client} client - ÙƒØ§Ø¦Ù† Ø¹Ù…ÙŠÙ„ whatsapp-web.js.
 */
async function handleLecturesTableCommand(message, client) {
    const chat = await message.getChat();
    if (!chat.isGroup) {
        await message.reply(`âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± ÙŠØ¹Ù…Ù„ ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ÙÙ‚Ø·!${SIGNATURE}`);
        return;
    }

    await message.react('ğŸ“Š');
    await message.reply(`ğŸ”„ *Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª...*`);

    try {
        const lectures = await db.getAllLectures();
        
        if (lectures.length === 0) {
            await message.reply(`âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ù„Ù‡Ø§.${SIGNATURE}`);
            return;
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ§Ù„Ø­Ø©
        const validLectures = lectures.filter(lecture => 
            lecture.section_name && 
            lecture.class_name && 
            lecture.subject_name && 
            lecture.lecture_number && 
            lecture.professor_name
        );
        
        if (validLectures.length === 0) {
            await message.reply(`âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ§Ù„Ø­Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª.${SIGNATURE}`);
            return;
        }
        
        const { generateLecturesTablePDF } = require('../utils');
        const media = await generateLecturesTablePDF(validLectures);
        
        await client.sendMessage(chat.id._serialized, media, {
            caption: `ğŸ“Š *Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª*\n\nØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­.${SIGNATURE}`
        });
    } catch (error) {
        console.error('[âŒ] Error generating lectures table:', error);
        await message.reply(`âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª: ${error.message}${SIGNATURE}`);
    }
}

module.exports = {
    '!Ø§Ø¶Ø§ÙØ©_Ù…Ø­Ø§Ø¶Ø±Ø©': handleAddLectureCommand,
    '!add_lecture': handleAddLectureCommand,
    '!Ù‚Ø§Ø¦Ù…Ø©_Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª': handleListLecturesCommand,
    '!list_lectures': handleListLecturesCommand,
    '!Ø¬Ø¯ÙˆÙ„_Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª': handleLecturesTableCommand,
    '!lectures_table': handleLecturesTableCommand,
};
// commands/management-handler.js

const { isAdmin } = require('../utils');
const { SIGNATURE } = require('../config');
const state = require('../state');

/**
 * @description ÙŠØ¨Ø¯Ø£ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©.
 * @param {Message} message - ÙƒØ§Ø¦Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù† whatsapp-web.js.
 * @param {Client} client - ÙƒØ§Ø¦Ù† Ø¹Ù…ÙŠÙ„ whatsapp-web.js.
 */
async function handleManagementCommand(message, client) {
    const chat = await message.getChat();
    const contact = await message.getContact();
    const authorId = contact.id._serialized;
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø´Ø±Ù
    if (chat.isGroup && !(await isAdmin(client, authorId, chat.id._serialized))) {
        await message.reply(`âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± Ù…ØªØ§Ø­ Ù„Ù„Ù…Ø´Ø±ÙÙŠÙ† ÙÙ‚Ø·!${SIGNATURE}`);
        return;
    }
    
    await message.react('âš™ï¸');
    const senderName = contact.pushname || "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…";
    
    const replyText = `
âš™ï¸ *Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…*

Ù…Ø±Ø­Ø¨Ø§Ù‹ ${senderName}! ğŸ™‹â€â™‚ï¸
ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø§Ù„Ù‚ÙŠØ§Ù… Ø¨Ù‡:

1. Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø¹Ø¨ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
2. Ø¥Ø¶Ø§ÙØ© Ø´Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©
3. ØªØ¹Ø¯ÙŠÙ„ Ø´Ø¹Ø¨Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©
4. Ø­Ø°Ù Ø´Ø¹Ø¨Ø©

ğŸ’¡ Ø£Ø±Ø³Ù„ Ø±Ù‚Ù… Ø§Ù„Ø®ÙŠØ§Ø± Ø£Ùˆ *Ø¥Ù„ØºØ§Ø¡* Ù„Ù„Ø®Ø±ÙˆØ¬.${SIGNATURE}`;
    
    await message.reply(replyText);
    state.userState.set(authorId, { 
        step: 'management_select_action', 
        timestamp: Date.now() 
    });
}

module.exports = {
    '!Ø¥Ø¯Ø§Ø±Ø©': handleManagementCommand,
    '!management': handleManagementCommand,
};
// commands/setup-handler-steps.js
// ÙŠØ­ØªÙˆÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ Ù…Ù†Ø·Ù‚ ÙƒÙ„ Ø®Ø·ÙˆØ© ÙÙŠ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©

const state = require('../state');
const db = require('../database');
const { SIGNATURE } = require('../config');

/**
 * @description Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ (Ø¹Ø±Ø¶ØŒ Ø¥Ø¶Ø§ÙØ©ØŒ ...)
 */
async function handleSetupSelectAction(message) {
    const authorId = message.author || message.from;
    const userState = state.userState.get(authorId);
    const choice = message.body.trim();

    if (choice === '1') {
        // Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø¹Ø¨ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
        if (state.sections.size === 0) {
            await message.reply(`â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙŠ Ø´Ø¹Ø¨ Ù…Ø¶Ø§ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹.${SIGNATURE}`);
        } else {
            let list = 'ğŸ“‹ *Ø§Ù„Ø´Ø¹Ø¨ Ø§Ù„Ù…Ø³Ø¬Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹:*\n\n';
            for (const [id, sectionData] of state.sections) {
                list += `- ${sectionData.name} (ID: ${id})\n`;
            }
            await message.reply(list + SIGNATURE);
        }
        state.userState.delete(authorId); // Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©

    } else if (choice === '2') {
        // Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø¥Ø¶Ø§ÙØ© Ø´Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©
        await message.reply(`âœ… Ø­Ø³Ù†Ù‹Ø§ØŒ Ù„Ù†Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø´Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©.\n\nğŸ“ *Ù…Ø§ Ù‡Ùˆ Ø§Ø³Ù… Ø§Ù„Ø´Ø¹Ø¨Ø©ØŸ* (Ù…Ø«Ø§Ù„: Ø´Ø¹Ø¨Ø© Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†)`);
        userState.step = 'setup_get_section_name';
        userState.setupData = {
            sectionName: '',
            classes: []
        };
    } else if (choice === '3' || choice === '4') {
        await message.reply(`ğŸš§ Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© Ù„Ø§ ØªØ²Ø§Ù„ Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±.${SIGNATURE}`);
        state.userState.delete(authorId);
    } else {
        await message.reply(`âš ï¸ Ø®ÙŠØ§Ø± ØºÙŠØ± ØµØ§Ù„Ø­. ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù‚Ù… Ù…Ù† 1 Ø¥Ù„Ù‰ 4.${SIGNATURE}`);
    }
}

/**
 * @description Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ø´Ø¹Ø¨Ø©
 */
async function handleSetupGetSectionName(message) {
    const authorId = message.author || message.from;
    const userState = state.userState.get(authorId);
    const sectionName = message.body.trim();

    if (sectionName.length < 3) {
        return message.reply(`âš ï¸ Ø§Ø³Ù… Ø§Ù„Ø´Ø¹Ø¨Ø© Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹. ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ØµØ­ÙŠØ­.`);
    }

    userState.setupData.sectionName = sectionName;
    userState.step = 'setup_get_class_count';
    await message.reply(`ğŸ‘ ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ø³Ù… Ø§Ù„Ø´Ø¹Ø¨Ø©: *${sectionName}*\n\nğŸ”¢ *ÙƒÙ… Ø¹Ø¯Ø¯ Ø§Ù„ÙØµÙˆÙ„ (Semesters) ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø¹Ø¨Ø©ØŸ* (Ù…Ø«Ø§Ù„: 2)`);
}

/**
 * @description Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø§Ù„ÙØµÙˆÙ„
 */
async function handleSetupGetClassCount(message) {
    const authorId = message.author || message.from;
    const userState = state.userState.get(authorId);
    const classCount = parseInt(message.body.trim());

    if (isNaN(classCount) || classCount <= 0 || classCount > 10) {
        return message.reply(`âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­ Ø¨ÙŠÙ† 1 Ùˆ 10.`);
    }
    
    userState.setupData.classCount = classCount;
    userState.setupData.classes = Array.from({ length: classCount });
    userState.currentClassIndex = 0; // Ø³Ù†Ø¨Ø¯Ø£ Ø¨Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„
    userState.step = 'setup_get_class_names';

    await message.reply(`ğŸ« Ø¬ÙŠØ¯ØŒ ${classCount} ÙØµÙˆÙ„.\n\n*Ø§Ù„Ø¢Ù†ØŒ Ù…Ø§ Ù‡Ùˆ Ø§Ø³Ù… Ø§Ù„ÙØµÙ„ Ø±Ù‚Ù… 1ØŸ* (Ù…Ø«Ø§Ù„: S1 Ø£Ùˆ Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„)`);
}

/**
 * @description Ø§Ù„Ø®Ø·ÙˆØ© 4: ØªÙƒØ±Ø§Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙØµÙˆÙ„ ÙˆØ§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ø£ÙÙˆØ§Ø¬
 */
async function handleSetupGetClassNames(message) {
    const authorId = message.author || message.from;
    const userState = state.userState.get(authorId);
    const { currentClassIndex, classCount } = userState.setupData;
    const className = message.body.trim();

    if (className.length < 2) {
        return message.reply(`âš ï¸ Ø§Ø³Ù… Ø§Ù„ÙØµÙ„ Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹.`);
    }
    
    // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ù„Ù„ÙØµÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ
    userState.setupData.classes[currentClassIndex] = {
        className: className,
        subjects: [],
        groups: []
    };

    userState.step = 'setup_get_subjects_for_class';
    await message.reply(`ğŸ“š ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ø³Ù… Ø§Ù„ÙØµÙ„: *${className}*\n\n*Ø§Ù„Ø¢Ù†ØŒ Ø£Ø¯Ø®Ù„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ÙˆØ§Ø¯ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙØµÙ„ØŒ Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø© (,)*\nÙ…Ø«Ø§Ù„: Ù‚Ø§Ù†ÙˆÙ†, Ø§Ù‚ØªØµØ§Ø¯, Ø´Ø±ÙŠØ¹Ø©`);
}

async function handleSetupGetSubjects(message) {
    const authorId = message.author || message.from;
    const userState = state.userState.get(authorId);
    const { currentClassIndex } = userState.setupData;

    const subjects = message.body.split(',').map(s => s.trim()).filter(Boolean);
    if (subjects.length === 0) {
        return message.reply('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø£ÙŠ Ù…ÙˆØ§Ø¯. ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ÙˆØ§Ø¯ Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø©.');
    }
    
    userState.setupData.classes[currentClassIndex].subjects = subjects;
    userState.step = 'setup_get_groups_and_profs';

    await message.reply(`ğŸ‘ ØªÙ… Ø¥Ø¶Ø§ÙØ© ${subjects.length} Ù…ÙˆØ§Ø¯.\n\n*Ø§Ù„Ø¢Ù†ØŒ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø£ÙÙˆØ§Ø¬ ÙˆØ§Ù„Ø£Ø³Ø§ØªØ°Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ÙØµÙ„ Ø¨Ø§Ù„ØµÙŠØºØ© Ø§Ù„ØªØ§Ù„ÙŠØ© (ÙƒÙ„ ÙÙˆØ¬ ÙÙŠ Ø³Ø·Ø±):*\n`
        + `*Ø§Ø³Ù… Ø§Ù„ÙÙˆØ¬ 1 : Ø§Ø³Ù… Ø§Ù„Ø£Ø³ØªØ§Ø° 1*\n`
        + `*Ø§Ø³Ù… Ø§Ù„ÙÙˆØ¬ 2 : Ø§Ø³Ù… Ø§Ù„Ø£Ø³ØªØ§Ø° 2*\n`
        + `Ù…Ø«Ø§Ù„:\nØ§Ù„ÙÙˆØ¬ Ø§Ù„Ø£ÙˆÙ„ : Ø£Ø³ØªØ§Ø° Ù…Ø­Ù…Ø¯\nØ§Ù„ÙÙˆØ¬ Ø§Ù„Ø«Ø§Ù†ÙŠ : Ø£Ø³ØªØ§Ø°Ø© ÙØ§Ø·Ù…Ø©`
    );
}

async function handleSetupGetGroupsAndProfs(message) {
    const authorId = message.author || message.from;
    const userState = state.userState.get(authorId);
    const { currentClassIndex, classCount } = userState.setupData;

    const lines = message.body.split('\n').filter(Boolean);
    const groups = [];
    for (const line of lines) {
        const parts = line.split(':');
        if (parts.length === 2) {
            groups.push({ groupName: parts[0].trim(), professorName: parts[1].trim() });
        }
    }

    if (groups.length === 0) {
        return message.reply(`âš ï¸ Ù„Ù… ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø£ÙÙˆØ§Ø¬ Ø¨Ø§Ù„ØµÙŠØºØ© Ø§Ù„ØµØ­ÙŠØ­Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØµÙŠØºØ©:\nØ§Ø³Ù… Ø§Ù„ÙÙˆØ¬ : Ø§Ø³Ù… Ø§Ù„Ø£Ø³ØªØ§Ø°`);
    }

    userState.setupData.classes[currentClassIndex].groups = groups;
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ Ø§Ù†ØªÙ‡ÙŠÙ†Ø§ Ù…Ù† ÙƒÙ„ Ø§Ù„ÙØµÙˆÙ„
    if (currentClassIndex + 1 < classCount) {
        userState.setupData.currentClassIndex++;
        userState.step = 'setup_get_class_names';
        await message.reply(`âœ… ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙØµÙ„ ${currentClassIndex + 1} Ø¨Ù†Ø¬Ø§Ø­.\n\n*Ù†Ù†ØªÙ‚Ù„ Ù„Ù„ÙØµÙ„ Ø§Ù„ØªØ§Ù„ÙŠ. Ù…Ø§ Ù‡Ùˆ Ø§Ø³Ù… Ø§Ù„ÙØµÙ„ Ø±Ù‚Ù… ${currentClassIndex + 2}ØŸ*`);
    } else {
        // Ø§Ù†ØªÙ‡ÙŠÙ†Ø§ØŒ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø®Øµ
        userState.step = 'setup_confirm_and_save';
        let summary = `ğŸ‰ *Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯! ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:*\n\n`
            + `*Ø§Ù„Ø´Ø¹Ø¨Ø©:* ${userState.setupData.sectionName}\n\n`;
        
        userState.setupData.classes.forEach((classData, index) => {
            summary += `*Ø§Ù„ÙØµÙ„ ${index + 1}: ${classData.className}*\n`
                + `  - Ø§Ù„Ù…ÙˆØ§Ø¯: ${classData.subjects.join(', ')}\n`
                + `  - Ø§Ù„Ø£ÙÙˆØ§Ø¬ ÙˆØ§Ù„Ø£Ø³Ø§ØªØ°Ø©:\n`;
            classData.groups.forEach(g => {
                summary += `    â€¢ ${g.groupName} (Ø§Ù„Ø£Ø³ØªØ§Ø°: ${g.professorName})\n`;
            });
            summary += `\n`;
        });

        summary += `*Ù‡Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©ØŸ*\nØ£Ø±Ø³Ù„ "Ù†Ø¹Ù…" Ù„Ù„Ø­ÙØ¸ Ø£Ùˆ "Ø¥Ù„ØºØ§Ø¡" Ù„Ù„ØªØ¬Ø§Ù‡Ù„.`;
        await message.reply(summary);
    }
}

/**
 * @description Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø£Ø®ÙŠØ±Ø©: ØªØ£ÙƒÙŠØ¯ ÙˆØ­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
 */
async function handleSetupConfirmAndSave(message) {
    const authorId = message.author || message.from;
    const userState = state.userState.get(authorId);

    if (message.body.trim().toLowerCase() === 'Ù†Ø¹Ù…') {
        try {
            await message.react('ğŸ”„');
            // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            await db.saveSectionSetup(userState.setupData);
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‚Ø±Ø±Ø§Øª ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ù„ØªØ­Ø¯ÙŠØ«Ù‡Ø§
            const coursesData = await db.loadCoursesData();
            state.sections = coursesData.sections;
            state.classes = coursesData.classes;
            // ... (Ø¨Ù‚ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
            
            await message.reply(`âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø´Ø¹Ø¨Ø© "${userState.setupData.sectionName}" ÙˆÙƒÙ„ ØªÙØ§ØµÙŠÙ„Ù‡Ø§ Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!${SIGNATURE}`);
        } catch (error) {
            console.error('[âŒ] Error saving setup data:', error);
            await message.reply(`âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙØ§Ø¯Ø­ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸: ${error.message}${SIGNATURE}`);
        }
    } else {
        await message.reply(`ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©. Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª.${SIGNATURE}`);
    }
    state.userState.delete(authorId); // Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©
}

module.exports = {
    handleSetupSelectAction,
    handleSetupGetSectionName,
    handleSetupGetClassCount,
    handleSetupGetClassNames,
    handleSetupGetSubjects,
    handleSetupGetGroupsAndProfs,
    handleSetupConfirmAndSave,
};
// commands/setup-handler-steps.js
// ÙŠØ­ØªÙˆÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ Ù…Ù†Ø·Ù‚ ÙƒÙ„ Ø®Ø·ÙˆØ© ÙÙŠ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©

const state = require('../state');
const db = require('../database');
const { SIGNATURE } = require('../config');

/**
 * @description Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ (Ø¹Ø±Ø¶ØŒ Ø¥Ø¶Ø§ÙØ©ØŒ ...)
 */
async function handleSetupSelectAction(message) {
    const authorId = message.author || message.from;
    const userState = state.userState.get(authorId);
    const choice = message.body.trim();

    if (choice === '1') {
        // Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø¹Ø¨ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
        if (state.sections.size === 0) {
            await message.reply(`â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙŠ Ø´Ø¹Ø¨ Ù…Ø¶Ø§ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹.${SIGNATURE}`);
        } else {
            let list = 'ğŸ“‹ *Ø§Ù„Ø´Ø¹Ø¨ Ø§Ù„Ù…Ø³Ø¬Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹:*\n\n';
            for (const [id, sectionData] of state.sections) {
                list += `- ${sectionData.name} (ID: ${id})\n`;
            }
            await message.reply(list + SIGNATURE);
        }
        state.userState.delete(authorId); // Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©

    } else if (choice === '2') {
        // Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø¥Ø¶Ø§ÙØ© Ø´Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©
        await message.reply(`âœ… Ø­Ø³Ù†Ù‹Ø§ØŒ Ù„Ù†Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø´Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©.\n\nğŸ“ *Ù…Ø§ Ù‡Ùˆ Ø§Ø³Ù… Ø§Ù„Ø´Ø¹Ø¨Ø©ØŸ* (Ù…Ø«Ø§Ù„: Ø´Ø¹Ø¨Ø© Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†)`);
        userState.step = 'setup_get_section_name';
        userState.setupData = {
            sectionName: '',
            classes: []
        };
    } else if (choice === '3' || choice === '4') {
        await message.reply(`ğŸš§ Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© Ù„Ø§ ØªØ²Ø§Ù„ Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±.${SIGNATURE}`);
        state.userState.delete(authorId);
    } else {
        await message.reply(`âš ï¸ Ø®ÙŠØ§Ø± ØºÙŠØ± ØµØ§Ù„Ø­. ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù‚Ù… Ù…Ù† 1 Ø¥Ù„Ù‰ 4.${SIGNATURE}`);
    }
}

/**
 * @description Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ø´Ø¹Ø¨Ø©
 */
async function handleSetupGetSectionName(message) {
    const authorId = message.author || message.from;
    const userState = state.userState.get(authorId);
    const sectionName = message.body.trim();

    if (sectionName.length < 3) {
        return message.reply(`âš ï¸ Ø§Ø³Ù… Ø§Ù„Ø´Ø¹Ø¨Ø© Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹. ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ØµØ­ÙŠØ­.`);
    }

    userState.setupData.sectionName = sectionName;
    userState.step = 'setup_get_class_count';
    await message.reply(`ğŸ‘ ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ø³Ù… Ø§Ù„Ø´Ø¹Ø¨Ø©: *${sectionName}*\n\nğŸ”¢ *ÙƒÙ… Ø¹Ø¯Ø¯ Ø§Ù„ÙØµÙˆÙ„ (Semesters) ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø¹Ø¨Ø©ØŸ* (Ù…Ø«Ø§Ù„: 2)`);
}

/**
 * @description Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø§Ù„ÙØµÙˆÙ„
 */
async function handleSetupGetClassCount(message) {
    const authorId = message.author || message.from;
    const userState = state.userState.get(authorId);
    const classCount = parseInt(message.body.trim());

    if (isNaN(classCount) || classCount <= 0 || classCount > 10) {
        return message.reply(`âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­ Ø¨ÙŠÙ† 1 Ùˆ 10.`);
    }
    
    userState.setupData.classCount = classCount;
    userState.setupData.classes = Array.from({ length: classCount });
    userState.currentClassIndex = 0; // Ø³Ù†Ø¨Ø¯Ø£ Ø¨Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„
    userState.step = 'setup_get_class_names';

    await message.reply(`ğŸ« Ø¬ÙŠØ¯ØŒ ${classCount} ÙØµÙˆÙ„.\n\n*Ø§Ù„Ø¢Ù†ØŒ Ù…Ø§ Ù‡Ùˆ Ø§Ø³Ù… Ø§Ù„ÙØµÙ„ Ø±Ù‚Ù… 1ØŸ* (Ù…Ø«Ø§Ù„: S1 Ø£Ùˆ Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„)`);
}

/**
 * @description Ø§Ù„Ø®Ø·ÙˆØ© 4: ØªÙƒØ±Ø§Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙØµÙˆÙ„ ÙˆØ§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ø£ÙÙˆØ§Ø¬
 */
async function handleSetupGetClassNames(message) {
    const authorId = message.author || message.from;
    const userState = state.userState.get(authorId);
    const { currentClassIndex, classCount } = userState.setupData;
    const className = message.body.trim();

    if (className.length < 2) {
        return message.reply(`âš ï¸ Ø§Ø³Ù… Ø§Ù„ÙØµÙ„ Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹.`);
    }
    
    // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ù„Ù„ÙØµÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ
    userState.setupData.classes[currentClassIndex] = {
        className: className,
        subjects: [],
        groups: []
    };

    userState.step = 'setup_get_subjects_for_class';
    await message.reply(`ğŸ“š ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ø³Ù… Ø§Ù„ÙØµÙ„: *${className}*\n\n*Ø§Ù„Ø¢Ù†ØŒ Ø£Ø¯Ø®Ù„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ÙˆØ§Ø¯ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙØµÙ„ØŒ Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø© (,)*\nÙ…Ø«Ø§Ù„: Ù‚Ø§Ù†ÙˆÙ†, Ø§Ù‚ØªØµØ§Ø¯, Ø´Ø±ÙŠØ¹Ø©`);
}

async function handleSetupGetSubjects(message) {
    const authorId = message.author || message.from;
    const userState = state.userState.get(authorId);
    const { currentClassIndex } = userState.setupData;

    const subjects = message.body.split(',').map(s => s.trim()).filter(Boolean);
    if (subjects.length === 0) {
        return message.reply('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø£ÙŠ Ù…ÙˆØ§Ø¯. ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ÙˆØ§Ø¯ Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø©.');
    }
    
    userState.setupData.classes[currentClassIndex].subjects = subjects;
    userState.step = 'setup_get_groups_and_profs';

    await message.reply(`ğŸ‘ ØªÙ… Ø¥Ø¶Ø§ÙØ© ${subjects.length} Ù…ÙˆØ§Ø¯.\n\n*Ø§Ù„Ø¢Ù†ØŒ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø£ÙÙˆØ§Ø¬ ÙˆØ§Ù„Ø£Ø³Ø§ØªØ°Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ÙØµÙ„ Ø¨Ø§Ù„ØµÙŠØºØ© Ø§Ù„ØªØ§Ù„ÙŠØ© (ÙƒÙ„ ÙÙˆØ¬ ÙÙŠ Ø³Ø·Ø±):*\n`
        + `*Ø§Ø³Ù… Ø§Ù„ÙÙˆØ¬ 1 : Ø§Ø³Ù… Ø§Ù„Ø£Ø³ØªØ§Ø° 1*\n`
        + `*Ø§Ø³Ù… Ø§Ù„ÙÙˆØ¬ 2 : Ø§Ø³Ù… Ø§Ù„Ø£Ø³ØªØ§Ø° 2*\n`
        + `Ù…Ø«Ø§Ù„:\nØ§Ù„ÙÙˆØ¬ Ø§Ù„Ø£ÙˆÙ„ : Ø£Ø³ØªØ§Ø° Ù…Ø­Ù…Ø¯\nØ§Ù„ÙÙˆØ¬ Ø§Ù„Ø«Ø§Ù†ÙŠ : Ø£Ø³ØªØ§Ø°Ø© ÙØ§Ø·Ù…Ø©`
    );
}

async function handleSetupGetGroupsAndProfs(message) {
    const authorId = message.author || message.from;
    const userState = state.userState.get(authorId);
    const { currentClassIndex, classCount } = userState.setupData;

    const lines = message.body.split('\n').filter(Boolean);
    const groups = [];
    for (const line of lines) {
        const parts = line.split(':');
        if (parts.length === 2) {
            groups.push({ groupName: parts[0].trim(), professorName: parts[1].trim() });
        }
    }

    if (groups.length === 0) {
        return message.reply(`âš ï¸ Ù„Ù… ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø£ÙÙˆØ§Ø¬ Ø¨Ø§Ù„ØµÙŠØºØ© Ø§Ù„ØµØ­ÙŠØ­Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØµÙŠØºØ©:\nØ§Ø³Ù… Ø§Ù„ÙÙˆØ¬ : Ø§Ø³Ù… Ø§Ù„Ø£Ø³ØªØ§Ø°`);
    }

    userState.setupData.classes[currentClassIndex].groups = groups;
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ Ø§Ù†ØªÙ‡ÙŠÙ†Ø§ Ù…Ù† ÙƒÙ„ Ø§Ù„ÙØµÙˆÙ„
    if (currentClassIndex + 1 < classCount) {
        userState.setupData.currentClassIndex++;
        userState.step = 'setup_get_class_names';
        await message.reply(`âœ… ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙØµÙ„ ${currentClassIndex + 1} Ø¨Ù†Ø¬Ø§Ø­.\n\n*Ù†Ù†ØªÙ‚Ù„ Ù„Ù„ÙØµÙ„ Ø§Ù„ØªØ§Ù„ÙŠ. Ù…Ø§ Ù‡Ùˆ Ø§Ø³Ù… Ø§Ù„ÙØµÙ„ Ø±Ù‚Ù… ${currentClassIndex + 2}ØŸ*`);
    } else {
        // Ø§Ù†ØªÙ‡ÙŠÙ†Ø§ØŒ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø®Øµ
        userState.step = 'setup_confirm_and_save';
        let summary = `ğŸ‰ *Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯! ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:*\n\n`
            + `*Ø§Ù„Ø´Ø¹Ø¨Ø©:* ${userState.setupData.sectionName}\n\n`;
        
        userState.setupData.classes.forEach((classData, index) => {
            summary += `*Ø§Ù„ÙØµÙ„ ${index + 1}: ${classData.className}*\n`
                + `  - Ø§Ù„Ù…ÙˆØ§Ø¯: ${classData.subjects.join(', ')}\n`
                + `  - Ø§Ù„Ø£ÙÙˆØ§Ø¬ ÙˆØ§Ù„Ø£Ø³Ø§ØªØ°Ø©:\n`;
            classData.groups.forEach(g => {
                summary += `    â€¢ ${g.groupName} (Ø§Ù„Ø£Ø³ØªØ§Ø°: ${g.professorName})\n`;
            });
            summary += `\n`;
        });

        summary += `*Ù‡Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©ØŸ*\nØ£Ø±Ø³Ù„ "Ù†Ø¹Ù…" Ù„Ù„Ø­ÙØ¸ Ø£Ùˆ "Ø¥Ù„ØºØ§Ø¡" Ù„Ù„ØªØ¬Ø§Ù‡Ù„.`;
        await message.reply(summary);
    }
}

/**
 * @description Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø£Ø®ÙŠØ±Ø©: ØªØ£ÙƒÙŠØ¯ ÙˆØ­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
 */
async function handleSetupConfirmAndSave(message) {
    const authorId = message.author || message.from;
    const userState = state.userState.get(authorId);

    if (message.body.trim().toLowerCase() === 'Ù†Ø¹Ù…') {
        try {
            await message.react('ğŸ”„');
            // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            await db.saveSectionSetup(userState.setupData);
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‚Ø±Ø±Ø§Øª ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ù„ØªØ­Ø¯ÙŠØ«Ù‡Ø§
            const coursesData = await db.loadCoursesData();
            state.sections = coursesData.sections;
            state.classes = coursesData.classes;
            // ... (Ø¨Ù‚ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
            
            await message.reply(`âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø´Ø¹Ø¨Ø© "${userState.setupData.sectionName}" ÙˆÙƒÙ„ ØªÙØ§ØµÙŠÙ„Ù‡Ø§ Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!${SIGNATURE}`);
        } catch (error) {
            console.error('[âŒ] Error saving setup data:', error);
            await message.reply(`âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙØ§Ø¯Ø­ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸: ${error.message}${SIGNATURE}`);
        }
    } else {
        await message.reply(`ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©. Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª.${SIGNATURE}`);
    }
    state.userState.delete(authorId); // Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©
}

module.exports = {
    handleSetupSelectAction,
    handleSetupGetSectionName,
    handleSetupGetClassCount,
    handleSetupGetClassNames,
    handleSetupGetSubjects,
    handleSetupGetGroupsAndProfs,
    handleSetupConfirmAndSave,
};
// commands/setup-handler.js - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ÙˆØ§Ù„Ù…Ø¨Ø³Ø· Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯

const { SIGNATURE } = require('../config');
const state = require('../state');
const db = require('../database');

// =================================================================
// 1. Ø§Ù„Ø£Ù…Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯
// =================================================================
async function handleSetupCommand(message, client) {
    const chat = await message.getChat();
    const authorId = message.from;

    if (chat.isGroup) {
        return message.reply(`âš ï¸ ÙŠÙØ¶Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± ÙÙŠ Ø§Ù„Ø®Ø§Øµ Ù…Ø¹ÙŠ Ù„ØªØ¬Ù†Ø¨ Ø¥Ø²Ø¹Ø§Ø¬ Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©.${SIGNATURE}`);
    }

    if (!state.admins.has(authorId)) {
        return message.reply(`âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± Ù…ØªØ§Ø­ Ù„Ù…Ø·ÙˆØ±ÙŠ Ø§Ù„Ø¨ÙˆØª ÙÙ‚Ø·! (Ø§Ù„Ù…Ø¹Ø±Ù ${authorId} ØºÙŠØ± Ù…Ø³Ø¬Ù„).${SIGNATURE}`);
    }

    await message.react('ğŸ”§');
    const contact = await message.getContact();
    const senderName = contact.pushname || "Ø§Ù„Ù…Ø´Ø±Ù";

    const replyText = `
ğŸ”§ *Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØªÙƒÙˆÙŠÙ† Ø´Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©*

Ù…Ø±Ø­Ø¨Ø§Ù‹ ${senderName}! ğŸ™‹â€â™‚ï¸
Ø³Ù†Ù‚ÙˆÙ… Ø§Ù„Ø¢Ù† Ø¨ØªÙƒÙˆÙŠÙ† Ø´Ø¹Ø¨Ø© Ø¯Ø±Ø§Ø³ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©.

ğŸ“ *Ù…Ø§ Ù‡Ùˆ Ø§Ø³Ù… Ø§Ù„Ø´Ø¹Ø¨Ø© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ØŸ* (Ù…Ø«Ø§Ù„: Ø´Ø¹Ø¨Ø© Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†)`;

    await message.reply(replyText);
    state.userState.set(authorId, {
        step: 'setup_get_section_name',
        timestamp: Date.now(),
        setupData: { sectionName: '', classes: [] }
    });
}

// =================================================================
// 2. Ø¯ÙˆØ§Ù„ Ù…Ø¹Ø§Ù„Ø¬Ø© ÙƒÙ„ Ø®Ø·ÙˆØ© ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
// =================================================================

async function handleSetupGetSectionName(message) {
    const authorId = message.from;
    const userState = state.userState.get(authorId);
    const sectionName = message.body.trim();

    if (sectionName.length < 3) return message.reply(`âš ï¸ Ø§Ø³Ù… Ø§Ù„Ø´Ø¹Ø¨Ø© Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹.`);

    userState.setupData.sectionName = sectionName;
    userState.currentClassIndex = 0; // Ø³Ù†Ø¨Ø¯Ø£ Ø¨Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„
    userState.step = 'setup_get_class_name';
    await message.reply(`ğŸ‘ Ø§Ù„Ø´Ø¹Ø¨Ø©: *${sectionName}*\n\n*Ø§Ù„Ø¢Ù†ØŒ Ù„Ù†Ø¨Ø¯Ø£ Ø¨Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„.*\n*Ù…Ø§ Ù‡Ùˆ Ø§Ø³Ù… Ø§Ù„ÙØµÙ„ Ø±Ù‚Ù… 1ØŸ* (Ù…Ø«Ø§Ù„: S1 Ø£Ùˆ Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„)`);
}

async function handleSetupGetClassName(message) {
    const authorId = message.from;
    const userState = state.userState.get(authorId);
    const { currentClassIndex } = userState;
    const className = message.body.trim();

    if (className.length < 2) return message.reply(`âš ï¸ Ø§Ø³Ù… Ø§Ù„ÙØµÙ„ Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹.`);
    
    // ØªÙ‡ÙŠØ¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØµÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ
    userState.setupData.classes[currentClassIndex] = { className, subjects: [], groups: [] };
    userState.step = 'setup_get_subjects_for_class';
    await message.reply(`ğŸ“š Ø§Ù„ÙØµÙ„: *${className}*\n\n*Ø§Ù„Ø¢Ù†ØŒ Ø£Ø¯Ø®Ù„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ÙˆØ§Ø¯ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙØµÙ„ØŒ Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø© (,)*`);
}

async function handleSetupGetSubjects(message) {
    const authorId = message.from;
    const userState = state.userState.get(authorId);
    const { currentClassIndex } = userState;

    const subjects = message.body.split(',').map(s => s.trim()).filter(Boolean);
    if (subjects.length === 0) return message.reply('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø£ÙŠ Ù…ÙˆØ§Ø¯.');

    userState.setupData.classes[currentClassIndex].subjects = subjects;
    userState.step = 'setup_get_groups_and_profs';
    await message.reply(`ğŸ‘ ØªÙ… Ø¥Ø¶Ø§ÙØ© ${subjects.length} Ù…ÙˆØ§Ø¯.\n\n*Ø§Ù„Ø¢Ù†ØŒ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø£ÙÙˆØ§Ø¬ ÙˆØ§Ù„Ø£Ø³Ø§ØªØ°Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ÙØµÙ„ Ø¨Ø§Ù„ØµÙŠØºØ© Ø§Ù„ØªØ§Ù„ÙŠØ© (ÙƒÙ„ ÙÙˆØ¬ ÙÙŠ Ø³Ø·Ø±):*\n*Ø§Ø³Ù… Ø§Ù„ÙÙˆØ¬ : Ø§Ø³Ù… Ø§Ù„Ø£Ø³ØªØ§Ø°*`);
}

async function handleSetupGetGroupsAndProfs(message) {
    const authorId = message.from;
    const userState = state.userState.get(authorId);
    const { setupData } = userState;
    let { currentClassIndex } = userState;

    const lines = message.body.split('\n').filter(Boolean);
    const groups = [];
    for (const line of lines) {
        const parts = line.split(':');
        if (parts.length === 2 && parts[0].trim() && parts[1].trim()) {
            groups.push({ groupName: parts[0].trim(), professorName: parts[1].trim() });
        }
    }

    if (groups.length === 0) return message.reply(`âš ï¸ Ù„Ù… ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø£ÙÙˆØ§Ø¬ Ø¨Ø§Ù„ØµÙŠØºØ© Ø§Ù„ØµØ­ÙŠØ­Ø©.`);

    setupData.classes[currentClassIndex].groups = groups;

    await message.reply(`âœ… ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙØµÙ„: *${setupData.classes[currentClassIndex].className}*.\n\n*Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¶Ø§ÙØ© ÙØµÙ„ Ø¢Ø®Ø±ØŸ* (Ø£Ø±Ø³Ù„ "Ù†Ø¹Ù…" Ø£Ùˆ "Ù„Ø§")`);
    userState.step = 'setup_ask_for_another_class';
}

async function handleAskForAnotherClass(message) {
    const authorId = message.from;
    const userState = state.userState.get(authorId);
    const choice = message.body.trim().toLowerCase();

    if (choice === 'Ù†Ø¹Ù…') {
        userState.currentClassIndex++;
        userState.step = 'setup_get_class_name';
        await message.reply(`*Ù…Ø§ Ù‡Ùˆ Ø§Ø³Ù… Ø§Ù„ÙØµÙ„ Ø±Ù‚Ù… ${userState.currentClassIndex + 1}ØŸ*`);
    } else if (choice === 'Ù„Ø§') {
        userState.step = 'setup_confirm_and_save';
        let summary = `ğŸ‰ *Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯! ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:*\n\n*Ø§Ù„Ø´Ø¹Ø¨Ø©:* ${userState.setupData.sectionName}\n\n`;
        userState.setupData.classes.forEach((classData, index) => {
            if (classData) {
                summary += `*Ø§Ù„ÙØµÙ„ ${index + 1}: ${classData.className}*\n`
                    + `  - Ø§Ù„Ù…ÙˆØ§Ø¯: ${classData.subjects.join(', ')}\n`
                    + `  - Ø§Ù„Ø£ÙÙˆØ§Ø¬ ÙˆØ§Ù„Ø£Ø³Ø§ØªØ°Ø©:\n`;
                classData.groups.forEach(g => {
                    summary += `    â€¢ ${g.groupName} (Ø§Ù„Ø£Ø³ØªØ§Ø°: ${g.professorName})\n`;
                });
                summary += `\n`;
            }
        });
        summary += `*Ù‡Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©ØŸ*\nØ£Ø±Ø³Ù„ "Ù†Ø¹Ù…" Ù„Ù„Ø­ÙØ¸ Ø£Ùˆ "Ø¥Ù„ØºØ§Ø¡" Ù„Ù„ØªØ¬Ø§Ù‡Ù„.`;
        await message.reply(summary);
    } else {
        await message.reply(`âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø±Ø¯ Ø¨Ù€ "Ù†Ø¹Ù…" Ø£Ùˆ "Ù„Ø§".`);
    }
}

async function handleSetupConfirmAndSave(message) {
    const authorId = message.from;
    const userState = state.userState.get(authorId);

    if (message.body.trim().toLowerCase() === 'Ù†Ø¹Ù…') {
        try {
            await message.react('ğŸ”„');
            await db.saveSectionSetup(userState.setupData); // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ù„ØªØ­Ø¯ÙŠØ«Ù‡Ø§
            const coursesData = await db.loadCoursesData();
            state.sections = coursesData.sections;
            state.classes = coursesData.classes;
            state.subjects = coursesData.subjects;
            state.groupsData = coursesData.groups;
            state.professors = coursesData.professors;

            await message.reply(`âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø´Ø¹Ø¨Ø© "${userState.setupData.sectionName}" ÙˆÙƒÙ„ ØªÙØ§ØµÙŠÙ„Ù‡Ø§ Ø¨Ù†Ø¬Ø§Ø­!${SIGNATURE}`);
        } catch (error) {
            console.error('[âŒ] Error saving setup data:', error);
            await message.reply(`âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙØ§Ø¯Ø­ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸: ${error.message}${SIGNATURE}`);
        }
    } else {
        await message.reply(`ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©. Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª.${SIGNATURE}`);
    }
    state.userState.delete(authorId);
}

module.exports = {
    '!Ø¥Ø¹Ø¯Ø§Ø¯': handleSetupCommand,
    '!setup': handleSetupCommand,
    handleSetupSelectAction,
    handleSetupGetSectionName,
    handleSetupGetClassName,
    handleSetupGetSubjects,
    handleSetupGetGroupsAndProfs,
    handleAskForAnotherClass,
    handleSetupConfirmAndSave,
};
# ====================================================
#      Ù…Ù„Ù Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª Ù…Ø­Ù„ÙŠØ§Ù‹
# ====================================================

# --- Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø§Ù„Ùƒ (Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ø±Ù‚Ù… Ø¨Ø±Ù‚Ù…Ùƒ Ù…Ø¹ Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„Ø©) ---
OWNER_ID="212621957775@c.us"

# --- ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø¨ÙˆØª (ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ±Ù‡) ---
SIGNATURE="\n\nğŸ¤– Ø¨ÙˆØ§Ø³Ø·Ø© Ø¨ÙˆØª Ø§Ù„Ù…Ø·ÙˆØ±"

# --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Supabase) ---
# (Ø§Ø³ØªØ¨Ø¯Ù„ [YOUR-PASSWORD] Ø¨ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§ØªÙƒ)
DATABASE_URL="postgresql://postgres.aqvgvgaetoqktvhhvfhp:irizi2025***@aws-1-us-east-1.pooler.supabase.com:6543/postgres"

# --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ù„ÙØ§Øª (GitHub) ---
# (Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ø°ÙŠ Ù†Ø³Ø®ØªÙ‡ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø­Ø³Ø§Ø¨Ùƒ ÙÙŠ GitHub)
GITHUB_TOKEN="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"

# (Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù…Ùƒ Ø¹Ù„Ù‰ GitHub)
GITHUB_OWNER="irizi1"

# (Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø°ÙŠ Ø£Ù†Ø´Ø£ØªÙ‡ Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª)
GITHUB_REPO="boot"

# --- (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ù…ÙØªØ§Ø­ API Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ---
# AI_API_KEY="sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"

# --- (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ÙˆØ¶Ø¹ Ø§Ù„ØªØµØ­ÙŠØ­ ---
# (Ø§Ø¬Ø¹Ù„Ù‡Ø§ 'true' Ù„Ø¥Ø¸Ù‡Ø§Ø± ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ·ÙˆÙŠØ±)
DEBUG_MODE="false"

